<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Web Recommender for Cruising Ports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <link rel="stylesheet" th:href="@{/static/css/styles.css}" href="/static/css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-ship me-2"></i>
                Cruise Recommender
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item" id="myInterestsNavItem" style="display: none;">
                        <a class="nav-link" href="#myPersonalInterests">
                            <i class="fas fa-heart me-1"></i>My Interests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#ports" th:text="#{nav.ports}">Ports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#fleet-tracker">Fleet Tracker</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#foodie" th:text="#{nav.foodie}">Foodie</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#features" th:text="#{nav.features}">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/swagger-ui.html}" href="/api/v1/swagger-ui.html" target="_blank" th:text="#{nav.apiDocs}">API Docs</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/actuator/health}" href="/api/v1/actuator/health" target="_blank" th:text="#{nav.health}">Health</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-globe me-1"></i><span th:text="#{nav.language}">Language</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                            <li><a class="dropdown-item" href="?lang=en">English</a></li>
                            <li><a class="dropdown-item" href="?lang=de">Deutsch</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" id="loginNavItem">
                        <a class="nav-link" href="#" onclick="showLoginModal(); return false;">
                            <i class="fas fa-sign-in-alt me-1"></i><span th:text="#{nav.login}">Login</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" id="userNavItem" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i><span id="userNavName">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="#" onclick="logout(); return false;">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section (hidden for logged-in USER) -->
    <section id="heroSection" class="hero-section text-center">
        <div class="container">
            <p class="lead mb-4" th:text="#{hero.subtitle}">
                Social Web Recommender for Cruising Ports: an intelligent recommendation system for cruise passengers, local businesses, and port authorities
            </p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <p class="fs-5" th:text="#{hero.description}">
                        Leveraging RDF knowledge graphs, machine learning, and real-time publisher-subscriber systems 
                        to enhance the cruise tourism experience.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- My Personal Interests Section (shown when logged in as USER, replaces Hero) -->
    <section id="myPersonalInterests" class="py-5" style="display: none;">
        <div class="container">
            <div class="row text-center mb-4">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">
                        <i class="fas fa-heart me-3"></i>My Personal Interests
                    </h2>
                    <p class="lead">Customize your preferences to get better recommendations</p>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-filter me-2"></i>Set Your Preferences
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="interestsForm">
                                <!-- Cruise Ship -->
                                <div class="mb-4">
                                    <label for="cruiseShipInterests" class="form-label fw-bold">
                                        <i class="fas fa-ship me-2"></i>Cruise Ship Preferences
                                    </label>
                                    <input type="text" class="form-control" id="cruiseShipInterests" 
                                           placeholder="e.g., Large ships, Family-friendly, Luxury">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- Port of Call -->
                                <div class="mb-4">
                                    <label for="portInterests" class="form-label fw-bold">
                                        <i class="fas fa-anchor me-2"></i>Port of Call Preferences
                                    </label>
                                    <input type="text" class="form-control" id="portInterests" 
                                           placeholder="e.g., Mediterranean, Caribbean, Historical ports">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- Activities -->
                                <div class="mb-4">
                                    <label for="activityInterests" class="form-label fw-bold">
                                        <i class="fas fa-running me-2"></i>Activities
                                    </label>
                                    <input type="text" class="form-control" id="activityInterests" 
                                           placeholder="e.g., Swimming, Hiking, Snorkeling, Shopping">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- Tourist Attractions -->
                                <div class="mb-4">
                                    <label for="attractionInterests" class="form-label fw-bold">
                                        <i class="fas fa-camera me-2"></i>Tourist Attractions
                                    </label>
                                    <input type="text" class="form-control" id="attractionInterests" 
                                           placeholder="e.g., Museums, Beaches, Historical sites, Art galleries">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- Meal Venues -->
                                <div class="mb-4">
                                    <label for="mealVenueInterests" class="form-label fw-bold">
                                        <i class="fas fa-utensils me-2"></i>Meal Venues
                                    </label>
                                    <input type="text" class="form-control" id="mealVenueInterests" 
                                           placeholder="e.g., Fine dining, Local cuisine, Seafood, Vegetarian">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- Restaurants -->
                                <div class="mb-4">
                                    <label for="restaurantInterests" class="form-label fw-bold">
                                        <i class="fas fa-store me-2"></i>Restaurants
                                    </label>
                                    <input type="text" class="form-control" id="restaurantInterests" 
                                           placeholder="e.g., Italian, Asian, Mediterranean, Fast food">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- Shore Excursions -->
                                <div class="mb-4">
                                    <label for="excursionInterests" class="form-label fw-bold">
                                        <i class="fas fa-umbrella-beach me-2"></i>Shore Excursions
                                    </label>
                                    <input type="text" class="form-control" id="excursionInterests" 
                                           placeholder="e.g., Adventure tours, Cultural tours, Water sports, City tours">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <!-- General Interests -->
                                <div class="mb-4">
                                    <label for="generalInterests" class="form-label fw-bold">
                                        <i class="fas fa-star me-2"></i>General Interests
                                    </label>
                                    <input type="text" class="form-control" id="generalInterests" 
                                           placeholder="e.g., History, Art, Nature, Adventure, Food, Shopping">
                                    <small class="form-text text-muted">Enter keywords separated by commas</small>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="saveInterests()">
                                        <i class="fas fa-save me-2"></i>Save My Interests
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>My Interests as a Passenger
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="savedInterestsList">
                                <p class="text-muted">No interests saved yet. Set your preferences and click "Save My Interests".</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- User Recommendations Section (shown when logged in as USER) -->
    <section id="userRecommendations" class="py-5 bg-light" style="display: none;">
        <div class="container">
            <div class="row text-center mb-4">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">
                        <i class="fas fa-user-circle me-3"></i>Your Personalized Recommendations
                    </h2>
                    <p class="lead">Welcome, <span id="userName"></span>!</p>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <label for="userPortSelect" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-2"></i>Select a Port for Recommendations:
                            </label>
                            <select id="userPortSelect" class="form-select form-select-lg">
                                <option value="">-- Select a Port --</option>
                                <!-- Ports will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="userRecommendationsContent" style="display: none;">
                <!-- Port Map -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-map me-2"></i>Port Location Map
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="userPortMap" style="height: 400px; width: 100%; border-radius: 8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Foodie Details -->
                <div class="row mb-4" id="userFoodieSection" style="display: none;">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-drumstick-bite me-2"></i>Main Dish
                                </h5>
                            </div>
                            <div class="card-body">
                                <h4 id="userFoodieMainName" class="text-warning mb-3"></h4>
                                <p id="userFoodieMainRecipe" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-birthday-cake me-2"></i>Dessert
                                </h5>
                            </div>
                            <div class="card-body">
                                <h4 id="userFoodieDessertName" class="text-danger mb-3"></h4>
                                <p id="userFoodieDessertRecipe" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-umbrella-beach me-2"></i>Shore Excursions
                                </h5>
                            </div>
                            <div class="card-body" id="shoreExcursionsContent">
                                <p class="text-muted">Select a port to see recommendations</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-utensils me-2"></i>Meal Venues
                                </h5>
                            </div>
                            <div class="card-body" id="mealVenuesContent">
                                <p class="text-muted">Select a port to see recommendations</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Ports Section -->
    <section id="ports" class="py-5">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold" th:text="#{ports.title}">Featured Ports</h2>
                    <p class="lead" th:text="#{ports.subtitle}">Explore our supported cruise ports</p>
                </div>
            </div>
            
            <!-- Port Selector and Map -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center port-selector">
                                <div class="col-md-4">
                                    <label for="portSelect" class="form-label fw-bold">
                                        <i class="fas fa-map-marker-alt me-2"></i><span th:text="#{ports.selectPort}">Select a Port:</span>
                                    </label>
                                    <label for="portSearch" class="visually-hidden">Search ports</label>
                                    <input type="text" id="portSearch" class="form-control mb-2" 
                                           th:placeholder="#{ports.searchPorts}" 
                                           placeholder="Search ports..." 
                                           aria-label="Search ports"
                                           onkeyup="filterPorts()">
                                    <select id="portSelect" class="form-select form-select-lg" size="10" style="max-height: 300px;">
                                        <option value="" th:text="#{ports.selectPortPlaceholder}">-- Select a Port --</option>
                                        <!-- Ports will be loaded dynamically from database -->
                                    </select>
                                    <small class="text-muted" id="portCount">Total ports: 0</small>
                                </div>
                                <div class="col-md-8">
                                    <div id="portInfo" class="text-muted" style="display: none;">
                                        <p class="mb-1"><strong id="portName"></strong></p>
                                        <p class="mb-0"><small id="portDetails"></small></p>
                                    </div>
                                    <div id="map" style="height: 500px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Port Cards -->
            <div class="row" id="portCardsContainer">
                <div class="col-12 text-center">
                    <p class="text-muted" th:text="#{ports.selectPortToView}">Select a port to view details</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Fleet Tracker Section -->
    <section id="fleet-tracker" class="py-5 bg-light">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">
                        <i class="fas fa-ship me-3"></i>Fleet Tracker
                    </h2>
                    <p class="lead">Track cruise ships in real-time using AIS data</p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <script type="text/javascript">
                                // Map appearance - Required by vesselfinder.com AIS map script
                                // These variables are used by the external script, not our code
                                /* eslint-disable no-unused-vars */
                                const width="100%";         // width in pixels or percentage
                                const height="500";         // height in pixels
                                const latitude="36.00";     // center latitude (decimal degrees)
                                const longitude="-5.40";    // center longitude (decimal degrees)
                                const names=true;           // always show ship names (defaults to false)

                                // Fleet tracking - Required by vesselfinder.com AIS map script
                                const fleet="32d95ba7142bf60d814fe72fa0a0ee9d";
                                const fleet_name="Default Fleet";
                                const fleet_timespan="1440"; // maximum age in minutes of the displayed ship positions
                                /* eslint-enable no-unused-vars */
                            </script>
                            <div id="vesselfinderMapContainer">
                                <script type="text/javascript" src="https://www.vesselfinder.com/aismap.js"></script>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-search me-2"></i>Find Ship on Map
                            </h5>
                        </div>
                        <div class="card-body">
                            <label for="shipSelect" class="form-label fw-bold">
                                Select a Cruise Ship:
                            </label>
                            <select id="shipSelect" class="form-select form-select-lg mb-3">
                                <option value="">-- Select a Ship --</option>
                                <!-- Ships will be loaded dynamically -->
                            </select>
                            <div id="shipInfo" class="alert alert-info" style="display: none;">
                                <strong id="selectedShipName"></strong><br>
                                <small id="selectedShipDetails"></small>
                            </div>
                            <button id="highlightShipBtn" class="btn btn-primary w-100" disabled onclick="highlightShipOnMap()">
                                <i class="fas fa-map-marker-alt me-2"></i>Highlight on Map
                            </button>
                            <p class="text-muted small mt-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Select a ship from the dropdown and click "Highlight on Map" to find it on the vesselfinder map.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Foodie Section -->
    <section id="foodie" class="py-5 bg-light">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">
                        <i class="fas fa-utensils me-3"></i><span th:text="#{foodie.title}">Foodie Delights</span>
                    </h2>
                    <p class="lead" th:text="#{foodie.subtitle}">Discover local culinary specialties at each port</p>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <label for="foodiePortSelect" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-2"></i><span th:text="#{foodie.selectPort}">Select a Port to View Foodie Information:</span>
                            </label>
                            <select id="foodiePortSelect" class="form-select form-select-lg">
                                <option value="" th:text="#{ports.selectPortPlaceholder}">-- Select a Port --</option>
                                <!-- Ports will be loaded dynamically from database -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="foodieContent" style="display: none;">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-drumstick-bite me-2"></i><span th:text="#{foodie.mainDish}">Main Dish</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <h4 id="foodieMainName" class="text-primary mb-3"></h4>
                                <p id="foodieMainRecipe" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-birthday-cake me-2"></i><span th:text="#{foodie.dessert}">Dessert</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <h4 id="foodieDessertName" class="text-warning mb-3"></h4>
                                <p id="foodieDessertRecipe" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="foodieNoData" class="text-center text-muted" style="display: none;">
                <p><i class="fas fa-info-circle me-2"></i><span th:text="#{foodie.noData}">No foodie information available for the selected port.</span></p>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-5">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold" th:text="#{features.title}">Key Features</h2>
                    <p class="lead" th:text="#{features.subtitle}">Comprehensive solutions for the cruise tourism ecosystem</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                            <h5 class="card-title" th:text="#{features.aiRecommendations}">AI-Powered Recommendations</h5>
                            <p class="card-text" th:text="#{features.aiDescription}">
                                Machine learning algorithms provide personalized suggestions for attractions, 
                                restaurants, and activities based on user preferences and behavior.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-broadcast-tower fa-3x text-success mb-3"></i>
                            <h5 class="card-title" th:text="#{features.realTimeNotifications}">Real-time Notifications</h5>
                            <p class="card-text" th:text="#{features.realTimeDescription}">
                                Publisher-subscriber system enables instant communication between 
                                cruise passengers and local businesses.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-project-diagram fa-3x text-warning mb-3"></i>
                            <h5 class="card-title" th:text="#{features.knowledgeGraph}">Knowledge Graph Integration</h5>
                            <p class="card-text" th:text="#{features.knowledgeGraphDescription}">
                                RDF/SPARQL-based semantic data processing for enhanced 
                                recommendation accuracy and context understanding.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-ship fa-3x text-info mb-3"></i>
                            <h5 class="card-title" th:text="#{features.cruiseShipIntegration}">Cruise Ship Integration</h5>
                            <p class="card-text" th:text="#{features.cruiseShipDescription}">
                                Automated port arrival notifications and capacity planning 
                                for optimal passenger experience.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-3x text-danger mb-3"></i>
                            <h5 class="card-title" th:text="#{features.businessIntelligence}">Business Intelligence</h5>
                            <p class="card-text" th:text="#{features.businessIntelligenceDescription}">
                                Analytics dashboard for local businesses and port authorities 
                                to track performance and optimize operations.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-shield-alt fa-3x text-secondary mb-3"></i>
                            <h5 class="card-title" th:text="#{features.securityPrivacy}">Security & Privacy</h5>
                            <p class="card-text" th:text="#{features.securityPrivacyDescription}">
                                GDPR-compliant data handling and user privacy protection 
                                with JWT authentication and encryption.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="container">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-map-marker-alt fa-3x text-primary"></i>
                    </div>
                    <h3 class="fw-bold" id="statsPorts">400+</h3>
                    <p class="text-muted" th:text="#{stats.ports}">Cruise Ports</p>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-utensils fa-3x text-success"></i>
                    </div>
                    <h3 class="fw-bold">50+</h3>
                    <p class="text-muted" th:text="#{stats.restaurants}">Restaurants & Attractions</p>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-users fa-3x text-warning"></i>
                    </div>
                    <h3 class="fw-bold">1000+</h3>
                    <p class="text-muted" th:text="#{stats.users}">Potential Users</p>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-clock fa-3x text-info"></i>
                    </div>
                    <h3 class="fw-bold">24/7</h3>
                    <p class="text-muted" th:text="#{stats.realTime}">Real-time Updates</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Technology Stack -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold" th:text="#{tech.title}">Technology Stack</h2>
                    <p class="lead" th:text="#{tech.subtitle}">Built with modern, scalable technologies</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-3 text-center">
                    <i class="fab fa-java fa-3x text-primary mb-3"></i>
                    <h6 th:text="#{tech.java}">Java 17</h6>
                    <small class="text-muted" th:text="#{tech.javaDesc}">Runtime Environment</small>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-leaf fa-3x text-success mb-3"></i>
                    <h6 th:text="#{tech.springBoot}">Spring Boot</h6>
                    <small class="text-muted" th:text="#{tech.springBootDesc}">Application Framework</small>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-database fa-3x text-warning mb-3"></i>
                    <h6 th:text="#{tech.mysql}">MySQL 8.0</h6>
                    <small class="text-muted" th:text="#{tech.mysqlDesc}">Database</small>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-memory fa-3x text-danger mb-3"></i>
                    <h6 th:text="#{tech.redis}">Redis</h6>
                    <small class="text-muted" th:text="#{tech.redisDesc}">Caching</small>
                </div>
            </div>
        </div>
    </section>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">
                        <i class="fas fa-ship me-2"></i>Login
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="loginErrorMessage" class="alert alert-danger" style="display: none;"></div>
                    
                    <form id="loginModalForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                <input type="email" class="form-control" id="loginEmail" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" id="loginPassword" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                    </form>
                    
                    <hr class="my-3">
                    
                    <div class="text-center mb-3">
                        <p class="text-muted mb-2">Or login with:</p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary" onclick="loginWithFacebook()">
                                <i class="fab fa-facebook me-2"></i>Facebook
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="loginWithTwitter()">
                                <i class="fab fa-twitter me-2"></i>X
                            </button>
                            <button type="button" class="btn btn-outline-dark" onclick="loginWithTikTok()">
                                <i class="fab fa-tiktok me-2"></i>TikTok
                            </button>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="text-center">
                        <p class="text-muted mb-2">Don't have an account?</p>
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus me-2"></i>Register New User
                        </button>
                    </div>
                    
                    <!-- Registration Form (initially hidden) -->
                    <div id="registerModalForm" style="display: none; margin-top: 20px;">
                        <hr>
                        <h6 class="mb-3">Register New User</h6>
                        <div id="registerModalErrorMessage" class="alert alert-danger" style="display: none;"></div>
                        <div id="registerModalSuccessMessage" class="alert alert-success" style="display: none;"></div>
                        
                        <form id="registerModalFormFields">
                            <div class="mb-3">
                                <label for="regModalFirstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="regModalFirstName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="regModalLastName" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="regModalLastName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="regModalEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="regModalEmail" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="regModalPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="regModalPassword" required minlength="6">
                            </div>
                            
                            <div class="mb-3">
                                <label for="regModalRole" class="form-label">Role</label>
                                <select class="form-select" id="regModalRole">
                                    <option value="USER">User</option>
                                    <option value="ADMIN">Admin</option>
                                </select>
                                <small class="form-text text-muted">Note: Admin role grants access to maintenance panel</small>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideRegisterModal()">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-ship me-2"></i><span th:text="#{footer.title}">Social Web Recommender</span></h5>
                    <p class="mb-0" th:text="#{footer.description}">Enhancing cruise tourism through intelligent recommendations</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <a th:href="@{/swagger-ui.html}" href="/api/v1/swagger-ui.html" class="text-light me-3" th:text="#{nav.apiDocs}">API Documentation</a>
                        <a th:href="@{/actuator/health}" href="/api/v1/actuator/health" class="text-light" th:text="#{nav.health}">Health Check</a>
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0" th:text="#{footer.copyright}">&copy; 2024 Social Web Recommender Team. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
    
    <!-- Facebook SDK for JavaScript -->
    <script>
        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
    
    <script>
        /**
         * Leaflet map initialization
         * @global {Object} L - Leaflet library loaded from CDN
         */
        // Initialize map (will be centered when port is selected)
        let map = L.map('map').setView([41.3851, 2.1734], 6); // Default: Barcelona area
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Global variables for map markers
        let portMarker = null;
        let shipMarkers = [];
        let allPorts = []; // Store all ports from database
        
        // Get base path dynamically (handles context path and different servers)
        function getBasePath() {
            // If accessing through Spring Boot server (port 8080), use context path
            if (window.location.port === '8080' || window.location.hostname === 'localhost' && window.location.port === '') {
                const path = window.location.pathname;
                if (path.startsWith('/api/v1')) {
                    return '/api/v1';
                }
                return '/api/v1'; // Default to context path for Spring Boot
            }
            // If accessing through IntelliJ web server or other, use full Spring Boot URL
            return 'http://localhost:8080/api/v1';
        }
        
        // Facebook SDK initialization
        let facebookAppId = null;
        window.fbAsyncInit = function() {
            // Initialize the SDK with your app and the Graph API version for your app
            getFacebookAppId().then(appId => {
                if (appId) {
                    facebookAppId = appId;
                    FB.init({
                        appId: appId,
                        xfbml: true,
                        version: 'v24.0'
                    });
                    console.log('Facebook SDK initialized');
                } else {
                    console.warn('Facebook App ID not configured');
                }
            });
        };
        
        // Load ports from database API
        function loadPortsFromDatabase() {
            const basePath = getBasePath();
            const apiUrl = `${basePath}/ports`;
            console.log('Loading ports from', apiUrl, '...');
            console.log('Current page path:', window.location.pathname);
            fetch(apiUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(ports => {
                    console.log('Loaded', ports.length, 'ports from database');
                    console.log('First port sample:', ports[0]);
                    
                    if (!Array.isArray(ports)) {
                        console.error('Invalid ports data - not an array:', ports);
                        document.getElementById('portCount').textContent = 'Error: Invalid data format';
                        return;
                    }
                    
                    allPorts = ports;
                    
                    // Update stats
                    document.getElementById('statsPorts').textContent = ports.length + '+';
                    
                    // Populate port dropdown
                    const portSelect = document.getElementById('portSelect');
                    const foodiePortSelect = document.getElementById('foodiePortSelect');
                    
                    // Clear existing options (except first one)
                    portSelect.innerHTML = '<option value="">-- Select a Port --</option>';
                    foodiePortSelect.innerHTML = '<option value="">-- Select a Port --</option>';
                    
                    let portsAdded = 0;
                    ports.forEach(port => {
                        if (port && port.latitude != null && port.longitude != null && 
                            !isNaN(port.latitude) && !isNaN(port.longitude) &&
                            port.latitude !== 0 && port.longitude !== 0) {
                            const option = document.createElement('option');
                            option.value = port.id;
                            option.textContent = `${port.name || 'Unknown'} (${port.portCode || 'N/A'}) - ${port.country || 'Unknown'}`;
                            option.dataset.lat = port.latitude;
                            option.dataset.lng = port.longitude;
                            option.dataset.portName = port.name || 'Unknown';
                            option.dataset.country = port.country || '';
                            option.dataset.city = port.city || '';
                            option.dataset.capacity = port.berthsCapacity || 0;
                            portSelect.appendChild(option);
                            
                            // Also add to foodie dropdown
                            const foodieOption = option.cloneNode(true);
                            foodiePortSelect.appendChild(foodieOption);
                            portsAdded++;
                        } else {
                            console.warn('Skipping port with invalid coordinates:', port);
                        }
                    });
                    
                    document.getElementById('portCount').textContent = `Total ports: ${portsAdded} (${ports.length} total)`;
                    
                    if (portsAdded === 0) {
                        document.getElementById('portCount').textContent = 'No ports with valid coordinates found';
                        console.warn('No ports with valid coordinates found');
                    }
                })
                .catch(error => {
                    console.error('Error loading ports:', error);
                    document.getElementById('portCount').textContent = 'Error loading ports: ' + error.message;
                    // Show user-friendly error message
                    const portSelect = document.getElementById('portSelect');
                    const foodiePortSelect = document.getElementById('foodiePortSelect');
                    portSelect.innerHTML = '<option value="">Error loading ports. Please refresh the page.</option>';
                    foodiePortSelect.innerHTML = '<option value="">Error loading ports. Please refresh the page.</option>';
                });
        }
        
        // Port search filter function
        function filterPorts() {
            const searchTerm = document.getElementById('portSearch').value.toLowerCase();
            const select = document.getElementById('portSelect');
            const options = select.getElementsByTagName('option');
            let visibleCount = 0;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                // Always show the first option (placeholder)
                if (option.value === '') {
                    option.style.display = '';
                    continue;
                }
                
                const text = option.text.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            }
            
            // Update count display
            if (searchTerm) {
                document.getElementById('portCount').textContent = `${visibleCount} port(s) match "${searchTerm}"`;
            }
        }
        
        // Port selector change handler
        document.getElementById('portSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const portId = this.value;
            
            if (!portId || portId === '') {
                // Reset map to default view
                map.setView([41.3851, 2.1734], 6);
                document.getElementById('portInfo').style.display = 'none';
                document.getElementById('portCardsContainer').innerHTML = 
                    '<div class="col-12 text-center"><p class="text-muted">Select a port to view details</p></div>';
                clearMarkers();
                return;
            }
            
            const lat = parseFloat(selectedOption.dataset.lat);
            const lng = parseFloat(selectedOption.dataset.lng);
            const portName = selectedOption.dataset.portName || selectedOption.text;
            const country = selectedOption.dataset.country || '';
            const city = selectedOption.dataset.city || '';
            const capacity = selectedOption.dataset.capacity || 0;
            
            if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                console.error('Invalid coordinates for port:', portId, 'lat:', lat, 'lng:', lng);
                alert('Invalid coordinates for selected port. Please select another port.');
                return;
            }
            
            // Update port info
            document.getElementById('portName').textContent = portName + (country ? ' - ' + country : '');
            document.getElementById('portDetails').textContent = 
                `${city ? city + ', ' : ''}${country} | Capacity: ${capacity} | Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
            document.getElementById('portInfo').style.display = 'block';
            
            // Update port card
            const port = allPorts.find(p => p.id === Number(portId));
            if (port) {
                document.getElementById('portCardsContainer').innerHTML = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card port-card">
                            <div class="card-body">
                                <h5 class="card-title">${port.name}</h5>
                                <p class="card-text">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <span>${port.city || ''}, ${port.country || ''}</span>
                                </p>
                                <p class="card-text">
                                    <i class="fas fa-users me-2"></i>
                                    <span>Capacity: ${port.berthsCapacity || 0}</span>
                                </p>
                                <p class="card-text">
                                    <i class="fas fa-anchor me-2"></i>
                                    <span>Code: ${port.portCode || 'N/A'}</span>
                                </p>
                                ${port.tourism1 ? `<p class="card-text"><i class="fas fa-camera me-2"></i><span>${port.tourism1}</span></p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Center map on port with proper zoom
            map.setView([lat, lng], 13);
            map.invalidateSize(); // Ensure map resizes properly
            
            // Clear existing markers
            clearMarkers();
            
            // Add port marker
            portMarker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup(`<b>${portName}</b><br>Port Code: ${selectedOption.text.split('(')[1]?.split(')')[0] || 'N/A'}${country ? '<br>Country: ' + country : ''}`)
                .openPopup();
            
            // Ensure map view is updated after a brief delay
            setTimeout(() => {
                map.invalidateSize();
                map.setView([lat, lng], 13);
            }, 100);
            
            // Fetch ships near this port
            loadShipsNearPort(lat, lng);
        });
        
        // Foodie port selector change handler
        document.getElementById('foodiePortSelect').addEventListener('change', function() {
            const portId = this.value;
            
            if (!portId || portId === '') {
                document.getElementById('foodieContent').style.display = 'none';
                document.getElementById('foodieNoData').style.display = 'none';
                return;
            }
            
            // Fetch port details
            const basePath = getBasePath();
            fetch(`${basePath}/ports/${portId}`)
                .then(response => response.json())
                .then(port => {
                    const hasFoodieData = port.foodieMain || port.foodieDessert;
                    
                    if (!hasFoodieData) {
                        document.getElementById('foodieContent').style.display = 'none';
                        document.getElementById('foodieNoData').style.display = 'block';
                        return;
                    }
                    
                    document.getElementById('foodieNoData').style.display = 'none';
                    document.getElementById('foodieContent').style.display = 'block';
                    
                    // Parse and display foodie_main
                    // port.foodieMain and port.foodieDessert come from API response
                    if (port.foodieMain) {
                        try {
                            const foodieMain = typeof port.foodieMain === 'string' 
                                ? JSON.parse(port.foodieMain) 
                                : port.foodieMain;
                            document.getElementById('foodieMainName').textContent = foodieMain.name || 'N/A';
                            document.getElementById('foodieMainRecipe').textContent = foodieMain.recipe || 'No recipe available';
                        } catch (e) {
                            console.error('Error parsing foodieMain:', e);
                            document.getElementById('foodieMainName').textContent = 'N/A';
                            document.getElementById('foodieMainRecipe').textContent = 'Error loading recipe';
                        }
                    } else {
                        document.getElementById('foodieMainName').textContent = 'N/A';
                        document.getElementById('foodieMainRecipe').textContent = 'No main dish information available';
                    }
                    
                    // Parse and display foodie_dessert
                    if (port.foodieDessert) {
                        try {
                            const foodieDessert = typeof port.foodieDessert === 'string' 
                                ? JSON.parse(port.foodieDessert) 
                                : port.foodieDessert;
                            document.getElementById('foodieDessertName').textContent = foodieDessert.name || 'N/A';
                            document.getElementById('foodieDessertRecipe').textContent = foodieDessert.recipe || 'No recipe available';
                        } catch (e) {
                            console.error('Error parsing foodieDessert:', e);
                            document.getElementById('foodieDessertName').textContent = 'N/A';
                            document.getElementById('foodieDessertRecipe').textContent = 'Error loading recipe';
                        }
                    } else {
                        document.getElementById('foodieDessertName').textContent = 'N/A';
                        document.getElementById('foodieDessertRecipe').textContent = 'No dessert information available';
                    }
                })
                .catch(error => {
                    console.error('Error loading port foodie data:', error);
                    document.getElementById('foodieContent').style.display = 'none';
                    document.getElementById('foodieNoData').style.display = 'block';
                });
        });
        
        /**
         * Clear all markers from the map
         * map.removeLayer is a Leaflet method
         */
        function clearMarkers() {
            if (portMarker) {
                map.removeLayer(portMarker);
                portMarker = null;
            }
            shipMarkers.forEach(marker => map.removeLayer(marker));
            shipMarkers = [];
        }
        
        function loadShipsNearPort(lat, lng) {
            console.log('Loading ships near port:', lat, lng);
            
            // Call API to get ships near port (50 nautical miles radius)
            const basePath = getBasePath();
            fetch(`${basePath}/dashboard/ships/near-port?latitude=${lat}&longitude=${lng}&radius=50`)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            throw new Error('Failed to fetch ships: ' + response.status + ' - ' + text);
                        });
                    }
                    return response.json();
                })
                .then(ships => {
                    console.log('Loaded ships:', ships);
                    console.log('Number of ships:', ships.length);
                    
                    if (!Array.isArray(ships)) {
                        console.error('Invalid ships data:', ships);
                        return;
                    }
                    
                    let shipsAdded = 0;
                    ships.forEach(ship => {
                        if (ship && ship.latitude != null && ship.longitude != null && 
                            !isNaN(ship.latitude) && !isNaN(ship.longitude)) {
                            const shipIcon = L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            });
                            
                            const marker = L.marker([ship.latitude, ship.longitude], {icon: shipIcon})
                                .addTo(map)
                                .bindPopup(`
                                    <b>${ship.shipName || 'Unknown Ship'}</b><br>
                                    ${ship.cruiseLine ? 'Cruise Line: ' + ship.cruiseLine + '<br>' : ''}
                                    Speed: ${ship.speed != null ? ship.speed.toFixed(1) + ' knots' : 'N/A'}<br>
                                    Course: ${ship.course != null ? ship.course.toFixed(1) + '' : 'N/A'}<br>
                                    Status: ${ship.trackingStatus || 'Unknown'}<br>
                                    ${ship.lastUpdate ? 'Last Update: ' + new Date(ship.lastUpdate).toLocaleString() : ''}
                                `);
                            
                            shipMarkers.push(marker);
                            shipsAdded++;
                        } else {
                            console.warn('Skipping ship with invalid coordinates:', ship);
                        }
                    });
                    
                    console.log('Added', shipsAdded, 'ship markers to map');
                    
                    if (shipsAdded === 0) {
                        // Show info if no ships found
                        L.popup()
                            .setLatLng([lat, lng])
                            .setContent('No ships currently tracked near this port')
                            .openOn(map);
                    }
                })
                .catch(error => {
                    console.error('Error loading ships:', error);
                    // Show error message
                    L.popup()
                        .setLatLng([lat, lng])
                        .setContent('Error loading ship data: ' + error.message)
                        .openOn(map);
                });
        }
        
        // Initialize: Load ports from database when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadPortsFromDatabase();
            loadShipsForDropdown();
            checkLoginStatus();
        });
        
        // Get auth headers for API calls
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                console.log('Token found in localStorage, adding to Authorization header');
            } else {
                console.warn('No token found in localStorage');
            }
            return headers;
        }
        
        // Login Modal Functions
        function showLoginModal() {
            const modal = new bootstrap.Modal(document.getElementById('loginModal'));
            modal.show();
        }
        
        function showRegisterModal() {
            document.getElementById('registerModalForm').style.display = 'block';
            document.getElementById('loginModalForm').style.display = 'none';
        }
        
        function hideRegisterModal() {
            document.getElementById('registerModalForm').style.display = 'none';
            document.getElementById('loginModalForm').style.display = 'block';
            document.getElementById('registerModalFormFields').reset();
            document.getElementById('registerModalErrorMessage').style.display = 'none';
            document.getElementById('registerModalSuccessMessage').style.display = 'none';
        }
        
        // Check if user is logged in
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                // Try to get user info
                fetch(`${getBasePath()}/auth/me`, {
                    headers: getAuthHeaders(),
                    credentials: 'include'
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    return null;
                })
                .then(user => {
                    if (user) {
                        showUserInterface(user);
                    } else {
                        // Token invalid, clear it
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        // Reset UI to public view
                        document.getElementById('heroSection').style.display = 'block';
                        document.getElementById('myInterestsNavItem').style.display = 'none';
                        document.getElementById('myPersonalInterests').style.display = 'none';
                        document.getElementById('userRecommendations').style.display = 'none';
                    }
                })
                .catch(() => {
                    // Error fetching user info
                });
            } else {
                // Not logged in - ensure public view
                document.getElementById('heroSection').style.display = 'block';
                document.getElementById('myInterestsNavItem').style.display = 'none';
                document.getElementById('myPersonalInterests').style.display = 'none';
                document.getElementById('userRecommendations').style.display = 'none';
            }
        }
        
        // Show user interface after login
        function showUserInterface(user) {
            // Hide login button, show user menu
            document.getElementById('loginNavItem').style.display = 'none';
            document.getElementById('userNavItem').style.display = 'block';
            document.getElementById('userNavName').textContent = user.firstName || user.email;
            
            // Store user info
            localStorage.setItem('user', JSON.stringify(user));
            
            // Show sections based on role
            if (user.role === 'USER') {
                // Hide hero section for USER role
                document.getElementById('heroSection').style.display = 'none';
                
                // Show "My Interests" navigation link
                document.getElementById('myInterestsNavItem').style.display = 'block';
                
                // Show interests section first (replaces hero section)
                document.getElementById('myPersonalInterests').style.display = 'block';
                
                // Show user recommendations section
                document.getElementById('userRecommendations').style.display = 'block';
                document.getElementById('userName').textContent = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                
                // Keep other sections visible (ports, foodie, features)
                // They will appear in order after userRecommendations
                
                // Scroll to top to show personalized welcome
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Load ports for user recommendations dropdown
                loadPortsForUserRecommendations();
                
                // Load saved interests
                loadSavedInterests();
            } else {
                // ADMIN users don't see these sections
                document.getElementById('heroSection').style.display = 'block';
                document.getElementById('myInterestsNavItem').style.display = 'none';
                document.getElementById('myPersonalInterests').style.display = 'none';
                document.getElementById('userRecommendations').style.display = 'none';
            }
        }
        
        // Load ports for user recommendations dropdown
        function loadPortsForUserRecommendations() {
            const basePath = getBasePath();
            fetch(`${basePath}/ports`)
                .then(response => response.json())
                .then(ports => {
                    const select = document.getElementById('userPortSelect');
                    select.innerHTML = '<option value="">-- Select a Port --</option>';
                    ports.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port.id;
                        option.textContent = `${port.name} (${port.portCode || 'N/A'}) - ${port.country || 'Unknown'}`;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading ports for user recommendations:', error);
                });
        }
        
        // Handle login form submission
        document.getElementById('loginModalForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginErrorMessage');
            errorDiv.style.display = 'none';
            
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Store token in localStorage
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data));
                    
                    // Set cookie manually as fallback
                    document.cookie = `token=${data.token}; path=/api/v1; max-age=${7 * 24 * 60 * 60}; SameSite=Lax`;
                    document.cookie = `token=${data.token}; path=/; max-age=${7 * 24 * 60 * 60}; SameSite=Lax`;
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                    
                    // Handle redirect based on role
                    if (data.role === 'ADMIN') {
                        // Open admin maintenance in a new window
                        const currentPort = window.location.port;
                        let adminUrl;
                        if (currentPort === '63342' || currentPort === '') {
                            adminUrl = `http://localhost:8080/api/v1/admin/maintenance?token=${encodeURIComponent(data.token)}`;
                        } else {
                            adminUrl = `${basePath}/admin/maintenance?token=${encodeURIComponent(data.token)}`;
                        }
                        window.open(adminUrl, '_blank', 'width=1400,height=900');
                    } else {
                        // Show user interface on current page
                        showUserInterface(data);
                    }
                } else {
                    const error = await response.text();
                    errorDiv.textContent = error || 'Invalid email or password';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        });
        
        // Handle registration form submission
        document.getElementById('registerModalFormFields').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const registerData = {
                firstName: document.getElementById('regModalFirstName').value,
                lastName: document.getElementById('regModalLastName').value,
                email: document.getElementById('regModalEmail').value,
                password: document.getElementById('regModalPassword').value,
                role: document.getElementById('regModalRole').value
            };
            
            const errorDiv = document.getElementById('registerModalErrorMessage');
            const successDiv = document.getElementById('registerModalSuccessMessage');
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(registerData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    successDiv.textContent = `User registered successfully! Role: ${data.role}. You can now login.`;
                    successDiv.style.display = 'block';
                    
                    // Auto-fill login form
                    document.getElementById('loginEmail').value = registerData.email;
                    
                    // Hide register form after 2 seconds
                    setTimeout(() => {
                        hideRegisterModal();
                    }, 2000);
                } else {
                    const error = await response.text();
                    errorDiv.textContent = error || 'Registration failed. Please try again.';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Registration failed. Please try again.';
                errorDiv.style.display = 'block';
            }
        });
        
        // Handle user port selection for recommendations
        document.getElementById('userPortSelect').addEventListener('change', function() {
            const portId = this.value;
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!portId || !user.userId) {
                document.getElementById('userRecommendationsContent').style.display = 'none';
                return;
            }
            
            loadUserRecommendations(user.userId, portId);
        });
        
        // Load user recommendations
        async function loadUserRecommendations(userId, portId) {
            const basePath = getBasePath();
            
            try {
                // Get passenger ID (will auto-create if needed)
                let passengerId = userId; // Fallback
                
                try {
                    const passengerResponse = await fetch(`${basePath}/passengers?userId=${userId}`, {
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    
                    if (passengerResponse.ok) {
                        const passengers = await passengerResponse.json();
                        if (passengers && Array.isArray(passengers) && passengers.length > 0) {
                            passengerId = passengers[0].id;
                        }
                    }
                } catch (e) {
                    console.log('Could not fetch passengers, using userId:', e);
                }
                
                // Load port details for map and foodie
                let port = null;
                try {
                    const portResponse = await fetch(`${basePath}/ports/${portId}`);
                    if (portResponse.ok) {
                        port = await portResponse.json();
                        
                        // Display map
                        if (port.latitude && port.longitude) {
                            displayUserPortMap(port);
                        }
                        
                        // Display foodie details
                        if (port.foodieMain || port.foodieDessert) {
                            displayUserFoodieDetails(port);
                        } else {
                            document.getElementById('userFoodieSection').style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.error('Error loading port details:', e);
                }
                
                // Load shore excursions
                try {
                    const excursionsResponse = await fetch(`${basePath}/passengers/${passengerId}/shore-excursions?portId=${portId}`, {
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    
                    if (excursionsResponse.ok) {
                        const excursions = await excursionsResponse.json();
                        displayShoreExcursions(excursions);
                    } else {
                        document.getElementById('shoreExcursionsContent').innerHTML = '<p class="text-muted">No shore excursions available.</p>';
                    }
                } catch (e) {
                    console.error('Error loading shore excursions:', e);
                    document.getElementById('shoreExcursionsContent').innerHTML = '<p class="text-muted">Error loading shore excursions.</p>';
                }
                
                // Load meal venues
                try {
                    const mealsResponse = await fetch(`${basePath}/passengers/${passengerId}/lunch-venues?portId=${portId}`, {
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    
                    if (mealsResponse.ok) {
                        const meals = await mealsResponse.json();
                        displayMealVenues(meals);
                    } else {
                        document.getElementById('mealVenuesContent').innerHTML = '<p class="text-muted">No meal venues available.</p>';
                    }
                } catch (e) {
                    console.error('Error loading meal venues:', e);
                    document.getElementById('mealVenuesContent').innerHTML = '<p class="text-muted">Error loading meal venues.</p>';
                }
                
                document.getElementById('userRecommendationsContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading user recommendations:', error);
                document.getElementById('shoreExcursionsContent').innerHTML = '<p class="text-danger">Error loading recommendations</p>';
                document.getElementById('mealVenuesContent').innerHTML = '<p class="text-danger">Error loading recommendations</p>';
            }
        }
        
        // Display port map for user recommendations
        let userPortMap = null;
        function displayUserPortMap(port) {
            const mapDiv = document.getElementById('userPortMap');
            if (!mapDiv) return;
            
            // Clear existing map
            if (userPortMap) {
                userPortMap.remove();
                userPortMap = null;
            }
            
            if (!port.latitude || !port.longitude) {
                mapDiv.innerHTML = '<p class="text-muted">Map coordinates not available for this port.</p>';
                return;
            }
            
            // Create new map
            userPortMap = L.map('userPortMap').setView([port.latitude, port.longitude], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(userPortMap);
            
            // Add marker
            const marker = L.marker([port.latitude, port.longitude]).addTo(userPortMap);
            marker.bindPopup(`<b>${port.name}</b><br>${port.country || ''}`).openPopup();
        }
        
        // Display foodie details for user recommendations
        function displayUserFoodieDetails(port) {
            const foodieSection = document.getElementById('userFoodieSection');
            if (!foodieSection) return;
            
            foodieSection.style.display = 'block';
            
            // Parse and display foodie_main
            if (port.foodieMain) {
                try {
                    const foodieMain = typeof port.foodieMain === 'string' ? JSON.parse(port.foodieMain) : port.foodieMain;
                    document.getElementById('userFoodieMainName').textContent = foodieMain.name || 'Local Specialty';
                    document.getElementById('userFoodieMainRecipe').textContent = foodieMain.recipe || foodieMain.description || 'No recipe available.';
                } catch (e) {
                    document.getElementById('userFoodieMainName').textContent = 'Local Specialty';
                    document.getElementById('userFoodieMainRecipe').textContent = port.foodieMain;
                }
            } else {
                document.getElementById('userFoodieMainName').textContent = 'Not Available';
                document.getElementById('userFoodieMainRecipe').textContent = 'No main dish information available for this port.';
            }
            
            // Parse and display foodie_dessert
            if (port.foodieDessert) {
                try {
                    const foodieDessert = typeof port.foodieDessert === 'string' ? JSON.parse(port.foodieDessert) : port.foodieDessert;
                    document.getElementById('userFoodieDessertName').textContent = foodieDessert.name || 'Local Dessert';
                    document.getElementById('userFoodieDessertRecipe').textContent = foodieDessert.recipe || foodieDessert.description || 'No recipe available.';
                } catch (e) {
                    document.getElementById('userFoodieDessertName').textContent = 'Local Dessert';
                    document.getElementById('userFoodieDessertRecipe').textContent = port.foodieDessert;
                }
            } else {
                document.getElementById('userFoodieDessertName').textContent = 'Not Available';
                document.getElementById('userFoodieDessertRecipe').textContent = 'No dessert information available for this port.';
            }
        }
        
        // Display shore excursions
        function displayShoreExcursions(excursions) {
            const content = document.getElementById('shoreExcursionsContent');
            if (!excursions || excursions.length === 0) {
                content.innerHTML = '<p class="text-muted">No shore excursions available for this port.</p>';
                return;
            }
            
            let html = '<ul class="list-group list-group-flush">';
            excursions.slice(0, 5).forEach(excursion => {
                const name = excursion.name || excursion.excursionName || 'Shore Excursion';
                const desc = excursion.description || excursion.excursionDescription || '';
                const duration = excursion.duration || '';
                html += `
                    <li class="list-group-item">
                        <h6>${name}</h6>
                        ${desc ? `<p class="mb-1 small text-muted">${desc}</p>` : ''}
                        ${duration ? `<small class="text-muted"><i class="fas fa-clock me-1"></i>${duration}</small>` : ''}
                    </li>
                `;
            });
            html += '</ul>';
            content.innerHTML = html;
        }
        
        // Display meal venues
        function displayMealVenues(meals) {
            const content = document.getElementById('mealVenuesContent');
            if (!meals || meals.length === 0) {
                content.innerHTML = '<p class="text-muted">No meal venues available for this port.</p>';
                return;
            }
            
            let html = '<ul class="list-group list-group-flush">';
            meals.slice(0, 5).forEach(meal => {
                const name = meal.name || meal.venueName || 'Meal Venue';
                const desc = meal.description || meal.venueDescription || '';
                const cuisine = meal.cuisineType || '';
                html += `
                    <li class="list-group-item">
                        <h6>${name}</h6>
                        ${desc ? `<p class="mb-1 small text-muted">${desc}</p>` : ''}
                        ${cuisine ? `<small class="text-muted"><i class="fas fa-utensils me-1"></i>${cuisine}</small>` : ''}
                    </li>
                `;
            });
            html += '</ul>';
            content.innerHTML = html;
        }
        
        // Logout function
        async function logout() {
            try {
                const basePath = getBasePath();
                await fetch(`${basePath}/auth/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear client-side storage
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            // Clear cookies
            document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            document.cookie = 'token=; path=/api/v1; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            
            // Hide user interface, show login button
            document.getElementById('loginNavItem').style.display = 'block';
            document.getElementById('userNavItem').style.display = 'none';
            document.getElementById('myInterestsNavItem').style.display = 'none';
            document.getElementById('heroSection').style.display = 'block';
            document.getElementById('userRecommendations').style.display = 'none';
            document.getElementById('userRecommendationsContent').style.display = 'none';
            document.getElementById('myPersonalInterests').style.display = 'none';
        }
        
        // Social Login Functions
        async function loginWithFacebook() {
            try {
                // Check if Facebook SDK is loaded
                if (typeof FB === 'undefined') {
                    alert('Facebook SDK is still loading. Please wait a moment and try again.');
                    return;
                }
                
                // Ensure Facebook SDK is initialized
                if (!facebookAppId) {
                    const appId = await getFacebookAppId().catch(() => null);
                    if (!appId) {
                        alert('Facebook login is not configured. Please contact the administrator.');
                        return;
                    }
                    facebookAppId = appId;
                    FB.init({
                        appId: appId,
                        xfbml: true,
                        version: 'v24.0'
                    });
                }
                
                // Use Facebook SDK login dialog
                FB.login(function(response) {
                    if (response.authResponse) {
                        console.log('Welcome! Fetching your information....');
                        
                        // Get user information from Facebook
                        FB.api('/me', {fields: 'name,email'}, async function(userInfo) {
                            try {
                                const basePath = getBasePath();
                                
                                // Send Facebook access token and user info to backend for authentication
                                const loginResponse = await fetch(`${basePath}/auth/facebook/login`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    credentials: 'include',
                                    body: JSON.stringify({
                                        accessToken: response.authResponse.accessToken,
                                        userId: userInfo.id,
                                        name: userInfo.name,
                                        email: userInfo.email
                                    })
                                });
                                
                                if (loginResponse.ok) {
                                    const authData = await loginResponse.json();
                                    
                                    // Store authentication data
                                    if (authData.token) {
                                        localStorage.setItem('token', authData.token);
                                    }
                                    if (authData.userId) {
                                        localStorage.setItem('user', JSON.stringify({
                                            userId: authData.userId,
                                            email: authData.email,
                                            firstName: authData.firstName,
                                            lastName: authData.lastName,
                                            role: authData.role
                                        }));
                                    }
                                    
                                    // Update UI
                                    document.getElementById('loginNavItem').style.display = 'none';
                                    document.getElementById('userNavItem').style.display = 'block';
                                    document.getElementById('myInterestsNavItem').style.display = 'block';
                                    
                                    // Close login modal if open
                                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                                    if (loginModal) {
                                        loginModal.hide();
                                    }
                                    
                                    // Reload page to show user-specific content
                                    window.location.reload();
                                } else {
                                    const error = await loginResponse.text();
                                    alert('Facebook login failed: ' + error);
                                }
                            } catch (error) {
                                console.error('Error processing Facebook login:', error);
                                alert('Failed to complete Facebook login. Please try again.');
                            }
                        });
                    } else {
                        // User cancelled login or did not fully authorize
                        console.log('User cancelled login or did not fully authorize.');
                    }
                }, {scope: 'email,public_profile'});
            } catch (error) {
                console.error('Facebook login error:', error);
                alert('Failed to initiate Facebook login. Please try again.');
            }
        }
        
        // Helper function to get Facebook App ID from backend
        async function getFacebookAppId() {
            const basePath = getBasePath();
            try {
                const response = await fetch(`${basePath}/auth/facebook/config`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const config = await response.json();
                    return config.appId;
                }
            } catch (error) {
                console.warn('Could not fetch Facebook config from backend:', error);
            }
            
            // Fallback: return null to indicate configuration is needed
            return null;
        }
        
        function loginWithTwitter() {
            alert('Twitter login will be implemented. For now, please use email/password login.');
            // TODO: Implement Twitter OAuth
            // window.location.href = '/auth/twitter';
        }
        
        function loginWithTikTok() {
            alert('TikTok login will be implemented. For now, please use email/password login.');
            // TODO: Implement TikTok OAuth
            // window.location.href = '/auth/tiktok';
        }
        
        // Load saved interests
        async function loadSavedInterests() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!user.userId) return;
            
            try {
                const basePath = getBasePath();
                
                // Get passenger ID
                let passengerId = user.userId;
                try {
                    const passengerResponse = await fetch(`${basePath}/passengers?userId=${user.userId}`, {
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    
                    if (passengerResponse.ok) {
                        const passengers = await passengerResponse.json();
                        if (passengers && Array.isArray(passengers) && passengers.length > 0) {
                            passengerId = passengers[0].id;
                        } else {
                            // No passenger found, can't load interests
                            return;
                        }
                    }
                } catch (e) {
                    console.log('Could not fetch passengers:', e);
                    return;
                }
                
                // Load interests
                const interestsResponse = await fetch(`${basePath}/passengers/${passengerId}/interests`, {
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                
                if (interestsResponse.ok) {
                    const interests = await interestsResponse.json();
                    displaySavedInterests(interests);
                    
                    // Group interests by category and populate form fields
                    const interestsByCategory = {};
                    interests.forEach(interest => {
                        if (!interestsByCategory[interest.category]) {
                            interestsByCategory[interest.category] = [];
                        }
                        interestsByCategory[interest.category].push(interest.keyword);
                    });
                    
                    // Populate form fields
                    if (interestsByCategory['CRUISE_SHIP']) {
                        document.getElementById('cruiseShipInterests').value = interestsByCategory['CRUISE_SHIP'].join(', ');
                    }
                    if (interestsByCategory['PORT']) {
                        document.getElementById('portInterests').value = interestsByCategory['PORT'].join(', ');
                    }
                    if (interestsByCategory['ACTIVITY']) {
                        document.getElementById('activityInterests').value = interestsByCategory['ACTIVITY'].join(', ');
                    }
                    if (interestsByCategory['ATTRACTION']) {
                        document.getElementById('attractionInterests').value = interestsByCategory['ATTRACTION'].join(', ');
                    }
                    if (interestsByCategory['MEAL_VENUE']) {
                        document.getElementById('mealVenueInterests').value = interestsByCategory['MEAL_VENUE'].join(', ');
                    }
                    if (interestsByCategory['RESTAURANT']) {
                        document.getElementById('restaurantInterests').value = interestsByCategory['RESTAURANT'].join(', ');
                    }
                    if (interestsByCategory['EXCURSION']) {
                        document.getElementById('excursionInterests').value = interestsByCategory['EXCURSION'].join(', ');
                    }
                    if (interestsByCategory['GENERAL']) {
                        document.getElementById('generalInterests').value = interestsByCategory['GENERAL'].join(', ');
                    }
                }
            } catch (error) {
                console.error('Error loading saved interests:', error);
            }
        }
        
        // Display saved interests
        function displaySavedInterests(interests) {
            const listDiv = document.getElementById('savedInterestsList');
            
            if (!interests || interests.length === 0) {
                listDiv.innerHTML = '<p class="text-muted">No interests saved yet. Set your preferences and click "Save My Interests".</p>';
                return;
            }
            
            // Group by category
            const byCategory = {};
            interests.forEach(interest => {
                if (!byCategory[interest.category]) {
                    byCategory[interest.category] = [];
                }
                byCategory[interest.category].push(interest.keyword);
            });
            
            let html = '<div class="list-group">';
            Object.keys(byCategory).forEach(category => {
                html += `<div class="list-group-item"><strong>${category}:</strong> `;
                html += byCategory[category].join(', ');
                html += '</div>';
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
        }
        
        // Save interests
        async function saveInterests() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!user.userId) {
                alert('Please login first');
                return;
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                alert('No authentication token found. Please login again.');
                window.location.reload();
                return;
            }
            
            try {
                const basePath = getBasePath();
                const authHeaders = getAuthHeaders();
                
                console.log('Saving interests for user:', user.userId);
                console.log('Auth headers:', authHeaders);
                console.log('Token from localStorage:', token ? token.substring(0, 20) + '...' : 'null');
                console.log('Full token:', token);
                
                // Get passenger ID (will auto-create if needed)
                let passengerId = user.userId;
                try {
                    const passengerResponse = await fetch(`${basePath}/passengers?userId=${user.userId}`, {
                        headers: authHeaders,
                        credentials: 'include'
                    });
                    
                    console.log('Passenger response status:', passengerResponse.status);
                    
                    if (passengerResponse.ok) {
                        let passengers;
                        try {
                            const responseText = await passengerResponse.text();
                            console.log('Passenger response text length:', responseText.length);
                            passengers = JSON.parse(responseText);
                        } catch (jsonError) {
                            console.error('JSON parsing error:', jsonError);
                            alert('Error: Invalid response from server when fetching passenger profile. Please try again.');
                            return;
                        }
                        console.log('Passengers received:', passengers);
                        if (passengers && Array.isArray(passengers) && passengers.length > 0) {
                            passengerId = passengers[0].id;
                            console.log('Using passenger ID:', passengerId);
                        } else {
                            // Passenger will be auto-created by the endpoint, try again
                            console.log('No passengers found, retrying...');
                            const retryResponse = await fetch(`${basePath}/passengers?userId=${user.userId}`, {
                                headers: authHeaders,
                                credentials: 'include'
                            });
                            if (retryResponse.ok) {
                                let retryPassengers;
                                try {
                                    const retryText = await retryResponse.text();
                                    retryPassengers = JSON.parse(retryText);
                                } catch (jsonError) {
                                    console.error('JSON parsing error on retry:', jsonError);
                                    alert('Error: Invalid response from server when creating passenger profile. Please try again.');
                                    return;
                                }
                                if (retryPassengers && Array.isArray(retryPassengers) && retryPassengers.length > 0) {
                                    passengerId = retryPassengers[0].id;
                                    console.log('Passenger created with ID:', passengerId);
                                } else {
                                    const errorText = await retryResponse.text();
                                    alert('Unable to create passenger profile. Please try again. Error: ' + errorText);
                                    return;
                                }
                            } else {
                                const errorText = await retryResponse.text();
                                console.error('Retry failed:', retryResponse.status, errorText);
                                alert(`Unable to create passenger profile (${retryResponse.status}). Please try logging out and back in.`);
                                return;
                            }
                        }
                    } else {
                        const errorText = await passengerResponse.text();
                        console.error('Passenger fetch failed:', passengerResponse.status, errorText);
                        alert(`Error fetching passenger profile (${passengerResponse.status}): ${errorText.substring(0, 200)}`);
                        return;
                    }
                } catch (e) {
                    console.error('Could not fetch passengers:', e);
                    alert('Error: Could not find passenger profile. ' + e.message);
                    return;
                }
                
                // Collect interests from form
                const interests = [];
                
                // Helper function to add interests
                const addInterests = (category, value) => {
                    if (value && value.trim()) {
                        value.split(',').forEach(keyword => {
                            const trimmed = keyword.trim();
                            if (trimmed) {
                                interests.push({ category, keyword: trimmed });
                            }
                        });
                    }
                };
                
                addInterests('CRUISE_SHIP', document.getElementById('cruiseShipInterests').value);
                addInterests('PORT', document.getElementById('portInterests').value);
                addInterests('ACTIVITY', document.getElementById('activityInterests').value);
                addInterests('ATTRACTION', document.getElementById('attractionInterests').value);
                addInterests('MEAL_VENUE', document.getElementById('mealVenueInterests').value);
                addInterests('RESTAURANT', document.getElementById('restaurantInterests').value);
                addInterests('EXCURSION', document.getElementById('excursionInterests').value);
                addInterests('GENERAL', document.getElementById('generalInterests').value);
                
                // Save interests
                console.log('Saving interests:', interests);
                const response = await fetch(`${basePath}/passengers/${passengerId}/interests`, {
                    method: 'POST',
                    headers: authHeaders,
                    credentials: 'include',
                    body: JSON.stringify(interests)
                });
                
                console.log('Save interests response status:', response.status);
                
                if (response.ok) {
                    const savedInterests = await response.json();
                    displaySavedInterests(savedInterests);
                    alert('Your interests have been saved successfully!');
                } else {
                    const error = await response.text();
                    console.error('Error saving interests:', response.status, error);
                    if (response.status === 403) {
                        alert('Access denied (403). Your session may have expired. Please try logging out and back in.');
                    } else {
                        alert(`Error saving interests (${response.status}): ${error.substring(0, 200)}`);
                    }
                }
            } catch (error) {
                console.error('Error saving interests:', error);
                alert('Error saving interests: ' + error.message);
            }
        }
        
        // Load ships for dropdown
        async function loadShipsForDropdown() {
            try {
                const basePath = getBasePath();
                // Use public endpoint instead of admin endpoint
                const response = await fetch(`${basePath}/ships`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const ships = await response.json(); // This endpoint returns List directly
                    const shipSelect = document.getElementById('shipSelect');
                    
                    if (!shipSelect) {
                        console.log('Ship select dropdown not found, skipping ship loading');
                        return;
                    }
                    
                    // Clear existing options except the first one
                    shipSelect.innerHTML = '<option value="">-- Select a Ship --</option>';
                    
                    ships.forEach(ship => {
                        if (ship.name) {
                            const option = document.createElement('option');
                            option.value = ship.id;
                            option.textContent = `${ship.name}${ship.cruiseLine ? ' - ' + ship.cruiseLine : ''}`;
                            option.dataset.shipName = ship.name;
                            option.dataset.mmsi = ship.mmsi || '';
                            option.dataset.lat = ship.currentLatitude || '';
                            option.dataset.lng = ship.currentLongitude || '';
                            shipSelect.appendChild(option);
                        }
                    });
                    
                    // Enable ship selection
                    shipSelect.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        const shipInfo = document.getElementById('shipInfo');
                        const highlightBtn = document.getElementById('highlightShipBtn');
                        
                        if (this.value && shipInfo && highlightBtn) {
                            document.getElementById('selectedShipName').textContent = selectedOption.dataset.shipName;
                            const details = [];
                            if (selectedOption.dataset.mmsi) details.push(`MMSI: ${selectedOption.dataset.mmsi}`);
                            if (selectedOption.dataset.lat && selectedOption.dataset.lng) {
                                details.push(`Position: ${parseFloat(selectedOption.dataset.lat).toFixed(4)}, ${parseFloat(selectedOption.dataset.lng).toFixed(4)}`);
                            }
                            document.getElementById('selectedShipDetails').textContent = details.join(' | ') || 'No position data available';
                            shipInfo.style.display = 'block';
                            highlightBtn.disabled = false;
                        } else if (shipInfo && highlightBtn) {
                            shipInfo.style.display = 'none';
                            highlightBtn.disabled = true;
                        }
                    });
                } else {
                    console.error('Failed to load ships:', response.status);
                    const shipSelect = document.getElementById('shipSelect');
                    if (shipSelect) {
                        shipSelect.innerHTML = '<option value="">Error loading ships (may require login)</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading ships:', error);
                const shipSelect = document.getElementById('shipSelect');
                if (shipSelect) {
                    shipSelect.innerHTML = '<option value="">Error loading ships</option>';
                }
            }
        }
        
        // Highlight ship on vesselfinder map
        function highlightShipOnMap() {
            const shipSelect = document.getElementById('shipSelect');
            if (!shipSelect) return;
            
            const selectedOption = shipSelect.options[shipSelect.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Please select a ship first');
                return;
            }
            
            const shipName = selectedOption.dataset.shipName;
            const lat = selectedOption.dataset.lat;
            const lng = selectedOption.dataset.lng;
            const mmsi = selectedOption.dataset.mmsi;
            
            // Try to find the ship on the vesselfinder map by parsing DOM
            const mapContainer = document.getElementById('vesselfinderMapContainer');
            if (!mapContainer) {
                alert('Map container not found');
                return;
            }
            
            // Wait a bit for the map to fully load
            setTimeout(() => {
                // Look for ship markers/labels in the map
                const allElements = mapContainer.querySelectorAll('*');
                let found = false;
                
                // Search for elements containing the ship name
                allElements.forEach(element => {
                    const text = element.textContent || element.innerText || '';
                    if (text.includes(shipName) || (mmsi && text.includes(mmsi))) {
                        // Found a potential match
                        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        element.style.border = '3px solid red';
                        element.style.boxShadow = '0 0 10px red';
                        setTimeout(() => {
                            element.style.border = '';
                            element.style.boxShadow = '';
                        }, 5000);
                        found = true;
                    }
                });
                
                // If we have coordinates, display them
                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const iframe = mapContainer.querySelector('iframe');
                    if (iframe) {
                        console.log('Ship coordinates:', lat, lng);
                        alert(`Ship "${shipName}" coordinates: ${lat}, ${lng}\n\nIf the ship is visible on the map, it should be highlighted. Otherwise, use the coordinates to manually locate it on the map.`);
                    } else {
                        alert(`Ship "${shipName}" coordinates: ${lat}, ${lng}\n\nUse these coordinates to locate the ship on the map.`);
                    }
                } else {
                    if (!found) {
                        alert(`Ship "${shipName}" found in dropdown but no position data available.\n\nTry hovering over ship markers on the map to find "${shipName}".`);
                    } else {
                        alert(`Ship "${shipName}" should be highlighted on the map.`);
                    }
                }
            }, 2000); // Wait 2 seconds for map to load
        }
    </script>
</body>
</html>
