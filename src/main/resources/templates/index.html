<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Web Recommender for Cruising Ports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 100px 0;
        }
        .feature-card {
            transition: transform 0.3s ease;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .port-card {
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .stats-section {
            background-color: #f8f9fa;
            padding: 60px 0;
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .port-selector {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-ship me-2"></i>
                Cruise Recommender
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#features">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#ports">Ports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#foodie">Foodie</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/swagger-ui.html" target="_blank">API Docs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/actuator/health" target="_blank">Health</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-center">
        <div class="container">
            <h1 class="display-4 fw-bold mb-4">
                <i class="fas fa-ship me-3"></i>
                Social Web Recommender for Cruising Ports
            </h1>
            <p class="lead mb-4">
                An intelligent recommendation system for cruise passengers, local businesses, and port authorities
            </p>
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <p class="fs-5">
                        Leveraging RDF knowledge graphs, machine learning, and real-time publisher-subscriber systems 
                        to enhance the cruise tourism experience.
                    </p>
                </div>
            </div>
            <div class="mt-4">
                <a href="#features" class="btn btn-light btn-lg me-3">
                    <i class="fas fa-rocket me-2"></i>Explore Features
                </a>
                <a href="/swagger-ui.html" class="btn btn-outline-light btn-lg" target="_blank">
                    <i class="fas fa-code me-2"></i>API Documentation
                </a>
            </div>
        </div>
    </section>

    <!-- Ports Section - Moved right after Hero -->
    <section id="ports" class="py-5">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">Featured Ports</h2>
                    <p class="lead">Explore our supported cruise ports</p>
                </div>
            </div>
            
            <!-- Port Selector and Map -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center port-selector">
                                <div class="col-md-4">
                                    <label for="portSelect" class="form-label fw-bold">
                                        <i class="fas fa-map-marker-alt me-2"></i>Select a Port:
                                    </label>
                                    <input type="text" id="portSearch" class="form-control mb-2" 
                                           placeholder="Search ports..." 
                                           onkeyup="filterPorts()">
                                    <select id="portSelect" class="form-select form-select-lg" size="10" style="max-height: 300px;">
                                        <option value="">-- Select a Port --</option>
                                        <!-- Ports will be loaded dynamically from database -->
                                    </select>
                                    <small class="text-muted" id="portCount">Total ports: 0</small>
                                </div>
                                <div class="col-md-8">
                                    <div id="portInfo" class="text-muted" style="display: none;">
                                        <p class="mb-1"><strong id="portName"></strong></p>
                                        <p class="mb-0"><small id="portDetails"></small></p>
                                    </div>
                                    <div id="map" style="height: 500px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Port Cards -->
            <div class="row" id="portCardsContainer">
                <div class="col-12 text-center">
                    <p class="text-muted">Select a port to view details</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Foodie Section -->
    <section id="foodie" class="py-5 bg-light">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">
                        <i class="fas fa-utensils me-3"></i>Foodie Delights
                    </h2>
                    <p class="lead">Discover local culinary specialties at each port</p>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <label for="foodiePortSelect" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-2"></i>Select a Port to View Foodie Information:
                            </label>
                            <select id="foodiePortSelect" class="form-select form-select-lg">
                                <option value="">-- Select a Port --</option>
                                <!-- Ports will be loaded dynamically from database -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="foodieContent" style="display: none;">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-drumstick-bite me-2"></i>Main Dish
                                </h5>
                            </div>
                            <div class="card-body">
                                <h4 id="foodieMainName" class="text-primary mb-3"></h4>
                                <p id="foodieMainRecipe" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-birthday-cake me-2"></i>Dessert
                                </h5>
                            </div>
                            <div class="card-body">
                                <h4 id="foodieDessertName" class="text-warning mb-3"></h4>
                                <p id="foodieDessertRecipe" class="card-text"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="foodieNoData" class="text-center text-muted" style="display: none;">
                <p><i class="fas fa-info-circle me-2"></i>No foodie information available for the selected port.</p>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="py-5">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">Key Features</h2>
                    <p class="lead">Comprehensive solutions for the cruise tourism ecosystem</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">AI-Powered Recommendations</h5>
                            <p class="card-text">
                                Machine learning algorithms provide personalized suggestions for attractions, 
                                restaurants, and activities based on user preferences and behavior.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-broadcast-tower fa-3x text-success mb-3"></i>
                            <h5 class="card-title">Real-time Notifications</h5>
                            <p class="card-text">
                                Publisher-subscriber system enables instant communication between 
                                cruise passengers and local businesses.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-project-diagram fa-3x text-warning mb-3"></i>
                            <h5 class="card-title">Knowledge Graph Integration</h5>
                            <p class="card-text">
                                RDF/SPARQL-based semantic data processing for enhanced 
                                recommendation accuracy and context understanding.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-ship fa-3x text-info mb-3"></i>
                            <h5 class="card-title">Cruise Ship Integration</h5>
                            <p class="card-text">
                                Automated port arrival notifications and capacity planning 
                                for optimal passenger experience.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-3x text-danger mb-3"></i>
                            <h5 class="card-title">Business Intelligence</h5>
                            <p class="card-text">
                                Analytics dashboard for local businesses and port authorities 
                                to track performance and optimize operations.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card feature-card h-100 text-center p-4">
                        <div class="card-body">
                            <i class="fas fa-shield-alt fa-3x text-secondary mb-3"></i>
                            <h5 class="card-title">Security & Privacy</h5>
                            <p class="card-text">
                                GDPR-compliant data handling and user privacy protection 
                                with JWT authentication and encryption.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
        <div class="container">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-map-marker-alt fa-3x text-primary"></i>
                    </div>
                    <h3 class="fw-bold" id="statsPorts">400+</h3>
                    <p class="text-muted">Cruise Ports</p>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-utensils fa-3x text-success"></i>
                    </div>
                    <h3 class="fw-bold">50+</h3>
                    <p class="text-muted">Restaurants & Attractions</p>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-users fa-3x text-warning"></i>
                    </div>
                    <h3 class="fw-bold">1000+</h3>
                    <p class="text-muted">Potential Users</p>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <i class="fas fa-clock fa-3x text-info"></i>
                    </div>
                    <h3 class="fw-bold">24/7</h3>
                    <p class="text-muted">Real-time Updates</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Technology Stack -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="display-5 fw-bold">Technology Stack</h2>
                    <p class="lead">Built with modern, scalable technologies</p>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-3 text-center">
                    <i class="fab fa-java fa-3x text-primary mb-3"></i>
                    <h6>Java 17</h6>
                    <small class="text-muted">Runtime Environment</small>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-leaf fa-3x text-success mb-3"></i>
                    <h6>Spring Boot</h6>
                    <small class="text-muted">Application Framework</small>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-database fa-3x text-warning mb-3"></i>
                    <h6>MySQL 8.0</h6>
                    <small class="text-muted">Database</small>
                </div>
                <div class="col-md-3 text-center">
                    <i class="fas fa-memory fa-3x text-danger mb-3"></i>
                    <h6>Redis</h6>
                    <small class="text-muted">Caching</small>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-ship me-2"></i>Social Web Recommender</h5>
                    <p class="mb-0">Enhancing cruise tourism through intelligent recommendations</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <a href="/swagger-ui.html" class="text-light me-3">API Documentation</a>
                        <a href="/actuator/health" class="text-light">Health Check</a>
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2024 Social Web Recommender Team. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
    
    <script>
        // Initialize map (will be centered when port is selected)
        let map = L.map('map').setView([41.3851, 2.1734], 6); // Default: Barcelona area
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        let portMarker = null;
        let shipMarkers = [];
        let allPorts = []; // Store all ports from database
        
        // Get base path dynamically (handles context path and different servers)
        function getBasePath() {
            // If accessing through Spring Boot server (port 8080), use context path
            if (window.location.port === '8080' || window.location.hostname === 'localhost' && window.location.port === '') {
                const path = window.location.pathname;
                if (path.startsWith('/api/v1')) {
                    return '/api/v1';
                }
                return '/api/v1'; // Default to context path for Spring Boot
            }
            // If accessing through IntelliJ web server or other, use full Spring Boot URL
            return 'http://localhost:8080/api/v1';
        }
        
        // Load ports from database API
        function loadPortsFromDatabase() {
            const basePath = getBasePath();
            const apiUrl = `${basePath}/ports`;
            console.log('Loading ports from', apiUrl, '...');
            console.log('Current page path:', window.location.pathname);
            fetch(apiUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(ports => {
                    console.log('Loaded', ports.length, 'ports from database');
                    console.log('First port sample:', ports[0]);
                    
                    if (!Array.isArray(ports)) {
                        console.error('Invalid ports data - not an array:', ports);
                        document.getElementById('portCount').textContent = 'Error: Invalid data format';
                        return;
                    }
                    
                    allPorts = ports;
                    
                    // Update stats
                    document.getElementById('statsPorts').textContent = ports.length + '+';
                    
                    // Populate port dropdown
                    const portSelect = document.getElementById('portSelect');
                    const foodiePortSelect = document.getElementById('foodiePortSelect');
                    
                    // Clear existing options (except first one)
                    portSelect.innerHTML = '<option value="">-- Select a Port --</option>';
                    foodiePortSelect.innerHTML = '<option value="">-- Select a Port --</option>';
                    
                    let portsAdded = 0;
                    ports.forEach(port => {
                        if (port && port.latitude != null && port.longitude != null && 
                            !isNaN(port.latitude) && !isNaN(port.longitude) &&
                            port.latitude !== 0 && port.longitude !== 0) {
                            const option = document.createElement('option');
                            option.value = port.id;
                            option.textContent = `${port.name || 'Unknown'} (${port.portCode || 'N/A'}) - ${port.country || 'Unknown'}`;
                            option.dataset.lat = port.latitude;
                            option.dataset.lng = port.longitude;
                            option.dataset.portName = port.name || 'Unknown';
                            option.dataset.country = port.country || '';
                            option.dataset.city = port.city || '';
                            option.dataset.capacity = port.capacity || 0;
                            portSelect.appendChild(option);
                            
                            // Also add to foodie dropdown
                            const foodieOption = option.cloneNode(true);
                            foodiePortSelect.appendChild(foodieOption);
                            portsAdded++;
                        } else {
                            console.warn('Skipping port with invalid coordinates:', port);
                        }
                    });
                    
                    document.getElementById('portCount').textContent = `Total ports: ${portsAdded} (${ports.length} total)`;
                    
                    if (portsAdded === 0) {
                        document.getElementById('portCount').textContent = 'No ports with valid coordinates found';
                        console.warn('No ports with valid coordinates found');
                    }
                })
                .catch(error => {
                    console.error('Error loading ports:', error);
                    document.getElementById('portCount').textContent = 'Error loading ports: ' + error.message;
                    // Show user-friendly error message
                    const portSelect = document.getElementById('portSelect');
                    const foodiePortSelect = document.getElementById('foodiePortSelect');
                    portSelect.innerHTML = '<option value="">Error loading ports. Please refresh the page.</option>';
                    foodiePortSelect.innerHTML = '<option value="">Error loading ports. Please refresh the page.</option>';
                });
        }
        
        // Port search filter function
        function filterPorts() {
            const searchTerm = document.getElementById('portSearch').value.toLowerCase();
            const select = document.getElementById('portSelect');
            const options = select.getElementsByTagName('option');
            let visibleCount = 0;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                // Always show the first option (placeholder)
                if (option.value === '') {
                    option.style.display = '';
                    continue;
                }
                
                const text = option.text.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    option.style.display = '';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            }
            
            // Update count display
            if (searchTerm) {
                document.getElementById('portCount').textContent = `${visibleCount} port(s) match "${searchTerm}"`;
            }
        }
        
        // Port selector change handler
        document.getElementById('portSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const portId = this.value;
            
            if (!portId || portId === '') {
                // Reset map to default view
                map.setView([41.3851, 2.1734], 6);
                document.getElementById('portInfo').style.display = 'none';
                document.getElementById('portCardsContainer').innerHTML = 
                    '<div class="col-12 text-center"><p class="text-muted">Select a port to view details</p></div>';
                clearMarkers();
                return;
            }
            
            const lat = parseFloat(selectedOption.dataset.lat);
            const lng = parseFloat(selectedOption.dataset.lng);
            const portName = selectedOption.dataset.portName || selectedOption.text;
            const country = selectedOption.dataset.country || '';
            const city = selectedOption.dataset.city || '';
            const capacity = selectedOption.dataset.capacity || 0;
            
            if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                console.error('Invalid coordinates for port:', portId, 'lat:', lat, 'lng:', lng);
                alert('Invalid coordinates for selected port. Please select another port.');
                return;
            }
            
            // Update port info
            document.getElementById('portName').textContent = portName + (country ? ' - ' + country : '');
            document.getElementById('portDetails').textContent = 
                `${city ? city + ', ' : ''}${country} | Capacity: ${capacity} | Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
            document.getElementById('portInfo').style.display = 'block';
            
            // Update port card
            const port = allPorts.find(p => p.id == portId);
            if (port) {
                document.getElementById('portCardsContainer').innerHTML = `
                    <div class="col-md-6 col-lg-4">
                        <div class="card port-card">
                            <div class="card-body">
                                <h5 class="card-title">${port.name}</h5>
                                <p class="card-text">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    <span>${port.city || ''}, ${port.country || ''}</span>
                                </p>
                                <p class="card-text">
                                    <i class="fas fa-users me-2"></i>
                                    <span>Capacity: ${port.capacity || 0}</span>
                                </p>
                                <p class="card-text">
                                    <i class="fas fa-anchor me-2"></i>
                                    <span>Code: ${port.portCode || 'N/A'}</span>
                                </p>
                                ${port.tourism1 ? `<p class="card-text"><i class="fas fa-camera me-2"></i><span>${port.tourism1}</span></p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Center map on port
            map.setView([lat, lng], 12);
            
            // Clear existing markers
            clearMarkers();
            
            // Add port marker
            portMarker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup(`<b>${portName}</b><br>Port Code: ${selectedOption.text.split('(')[1]?.split(')')[0] || 'N/A'}${country ? '<br>Country: ' + country : ''}`)
                .openPopup();
            
            // Fetch ships near this port
            loadShipsNearPort(lat, lng);
        });
        
        // Foodie port selector change handler
        document.getElementById('foodiePortSelect').addEventListener('change', function() {
            const portId = this.value;
            
            if (!portId || portId === '') {
                document.getElementById('foodieContent').style.display = 'none';
                document.getElementById('foodieNoData').style.display = 'none';
                return;
            }
            
            // Fetch port details
            const basePath = getBasePath();
            fetch(`${basePath}/ports/${portId}`)
                .then(response => response.json())
                .then(port => {
                    const hasFoodieData = port.foodieMain || port.foodieDessert;
                    
                    if (!hasFoodieData) {
                        document.getElementById('foodieContent').style.display = 'none';
                        document.getElementById('foodieNoData').style.display = 'block';
                        return;
                    }
                    
                    document.getElementById('foodieNoData').style.display = 'none';
                    document.getElementById('foodieContent').style.display = 'block';
                    
                    // Parse and display foodie_main
                    if (port.foodieMain) {
                        try {
                            const foodieMain = typeof port.foodieMain === 'string' 
                                ? JSON.parse(port.foodieMain) 
                                : port.foodieMain;
                            document.getElementById('foodieMainName').textContent = foodieMain.name || 'N/A';
                            document.getElementById('foodieMainRecipe').textContent = foodieMain.recipe || 'No recipe available';
                        } catch (e) {
                            console.error('Error parsing foodieMain:', e);
                            document.getElementById('foodieMainName').textContent = 'N/A';
                            document.getElementById('foodieMainRecipe').textContent = 'Error loading recipe';
                        }
                    } else {
                        document.getElementById('foodieMainName').textContent = 'N/A';
                        document.getElementById('foodieMainRecipe').textContent = 'No main dish information available';
                    }
                    
                    // Parse and display foodie_dessert
                    if (port.foodieDessert) {
                        try {
                            const foodieDessert = typeof port.foodieDessert === 'string' 
                                ? JSON.parse(port.foodieDessert) 
                                : port.foodieDessert;
                            document.getElementById('foodieDessertName').textContent = foodieDessert.name || 'N/A';
                            document.getElementById('foodieDessertRecipe').textContent = foodieDessert.recipe || 'No recipe available';
                        } catch (e) {
                            console.error('Error parsing foodieDessert:', e);
                            document.getElementById('foodieDessertName').textContent = 'N/A';
                            document.getElementById('foodieDessertRecipe').textContent = 'Error loading recipe';
                        }
                    } else {
                        document.getElementById('foodieDessertName').textContent = 'N/A';
                        document.getElementById('foodieDessertRecipe').textContent = 'No dessert information available';
                    }
                })
                .catch(error => {
                    console.error('Error loading port foodie data:', error);
                    document.getElementById('foodieContent').style.display = 'none';
                    document.getElementById('foodieNoData').style.display = 'block';
                });
        });
        
        function clearMarkers() {
            if (portMarker) {
                map.removeLayer(portMarker);
                portMarker = null;
            }
            shipMarkers.forEach(marker => map.removeLayer(marker));
            shipMarkers = [];
        }
        
        function loadShipsNearPort(lat, lng) {
            console.log('Loading ships near port:', lat, lng);
            
            // Call API to get ships near port (50 nautical miles radius)
            const basePath = getBasePath();
            fetch(`${basePath}/dashboard/ships/near-port?latitude=${lat}&longitude=${lng}&radius=50`)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Error response:', text);
                            throw new Error('Failed to fetch ships: ' + response.status + ' - ' + text);
                        });
                    }
                    return response.json();
                })
                .then(ships => {
                    console.log('Loaded ships:', ships);
                    console.log('Number of ships:', ships.length);
                    
                    if (!Array.isArray(ships)) {
                        console.error('Invalid ships data:', ships);
                        return;
                    }
                    
                    let shipsAdded = 0;
                    ships.forEach(ship => {
                        if (ship && ship.latitude != null && ship.longitude != null && 
                            !isNaN(ship.latitude) && !isNaN(ship.longitude)) {
                            const shipIcon = L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34]
                            });
                            
                            const marker = L.marker([ship.latitude, ship.longitude], {icon: shipIcon})
                                .addTo(map)
                                .bindPopup(`
                                    <b>${ship.shipName || 'Unknown Ship'}</b><br>
                                    ${ship.cruiseLine ? 'Cruise Line: ' + ship.cruiseLine + '<br>' : ''}
                                    Speed: ${ship.speed != null ? ship.speed.toFixed(1) + ' knots' : 'N/A'}<br>
                                    Course: ${ship.course != null ? ship.course.toFixed(1) + 'Â°' : 'N/A'}<br>
                                    Status: ${ship.trackingStatus || 'Unknown'}<br>
                                    ${ship.lastUpdate ? 'Last Update: ' + new Date(ship.lastUpdate).toLocaleString() : ''}
                                `);
                            
                            shipMarkers.push(marker);
                            shipsAdded++;
                        } else {
                            console.warn('Skipping ship with invalid coordinates:', ship);
                        }
                    });
                    
                    console.log('Added', shipsAdded, 'ship markers to map');
                    
                    if (shipsAdded === 0) {
                        // Show info if no ships found
                        L.popup()
                            .setLatLng([lat, lng])
                            .setContent('No ships currently tracked near this port')
                            .openOn(map);
                    }
                })
                .catch(error => {
                    console.error('Error loading ships:', error);
                    // Show error message
                    L.popup()
                        .setLatLng([lat, lng])
                        .setContent('Error loading ship data: ' + error.message)
                        .openOn(map);
                });
        }
        
        // Initialize: Load ports from database when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadPortsFromDatabase();
        });
    </script>
</body>
</html>
