<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance - Cruise Recommender Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
         integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
         crossorigin=""/>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            position: fixed;
            width: 250px;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            display: block;
            transition: background-color 0.3s;
        }
        .sidebar a:hover {
            background-color: #495057;
        }
        .sidebar a.active {
            background-color: #667eea;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .table-actions {
            white-space: nowrap;
        }
        .modal-content {
            border-radius: 10px;
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: #f0f0f0;
        }
        .sortable i {
            margin-left: 5px;
            opacity: 0.5;
        }
        .sortable.active i {
            opacity: 1;
        }
        #portMap {
            height: 300px;
            width: 50%;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        .stat-card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card h4 {
            margin: 0;
            font-size: 1.8rem;
        }
        .stat-card small {
            display: block;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h4 class="mb-4 px-3"><i class="fas fa-ship me-2"></i>Admin Panel</h4>
        <a th:href="@{/admin/maintenance}" href="/api/v1/admin/maintenance" class="active">
            <i class="fas fa-tools me-2"></i>Maintenance
        </a>
        <a th:href="@{/admin/stats}" href="/api/v1/admin/stats">
            <i class="fas fa-chart-bar me-2"></i>Statistics
        </a>
        <hr class="text-white">
        <a href="#" onclick="window.location.href='/api/v1/'; return false;" style="cursor: pointer;">
            <i class="fas fa-home me-2"></i>Public Site
        </a>
        <a href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt me-2"></i>Logout
        </a>
    </div>
    
    <div class="main-content">
        <h1 class="mb-4">Database Maintenance</h1>
        
        <!-- Statistics Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-database fa-2x text-primary mb-2"></i>
                        <h4 id="sparqlTotalQueries">-</h4>
                        <p class="text-muted mb-1">SPARQL Queries</p>
                        <small class="text-muted" id="sparqlSuccessRate">-</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-exchange-alt fa-2x text-success mb-2"></i>
                        <h4 id="messageTotal">-</h4>
                        <p class="text-muted mb-1">Messages</p>
                        <small class="text-muted" id="messageConsumed">-</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-clock fa-2x text-info mb-2"></i>
                        <h4 id="avgDuration">-</h4>
                        <p class="text-muted mb-1">Avg Query Time</p>
                        <small class="text-muted">(ms)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                        <h4 id="activeProducers">-</h4>
                        <p class="text-muted mb-1">Active Producers</p>
                        <small class="text-muted">Ports</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-tachometer-alt fa-2x text-danger mb-2"></i>
                        <h4 id="apiTotalRequests">-</h4>
                        <p class="text-muted mb-1">API Requests</p>
                        <small class="text-muted" id="apiSuccessRate">-</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card text-center">
                    <div class="card-body">
                        <i class="fas fa-server fa-2x text-secondary mb-2"></i>
                        <h4 id="cpuUsage">-</h4>
                        <p class="text-muted mb-1">CPU Usage</p>
                        <small class="text-muted" id="memoryUsage">-</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- External Monitoring Links -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-external-link-alt me-2"></i>External Monitoring Dashboards</h5>
                        <div class="btn-group" role="group">
                            <a href="http://localhost:5601" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-chart-bar me-2"></i>Kibana
                            </a>
                            <a href="http://localhost:3001" target="_blank" class="btn btn-outline-info">
                                <i class="fas fa-chart-line me-2"></i>Grafana
                            </a>
                            <a href="http://localhost:9090" target="_blank" class="btn btn-outline-success">
                                <i class="fas fa-database me-2"></i>Prometheus
                            </a>
                            <a href="http://localhost:15672" target="_blank" class="btn btn-outline-warning">
                                <i class="fas fa-exchange-alt me-2"></i>RabbitMQ
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="maintenanceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ports-tab" data-bs-toggle="tab" data-bs-target="#ports" type="button">
                    <i class="fas fa-anchor me-2"></i>Ports
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ships-tab" data-bs-toggle="tab" data-bs-target="#ships" type="button">
                    <i class="fas fa-ship me-2"></i>Cruise Ships
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="meal-venues-tab" data-bs-toggle="tab" data-bs-target="#meal-venues" type="button">
                    <i class="fas fa-utensils me-2"></i>Meal Venues
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="restaurants-tab" data-bs-toggle="tab" data-bs-target="#restaurants" type="button">
                    <i class="fas fa-store me-2"></i>Restaurants
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-performance-tab" data-bs-toggle="tab" data-bs-target="#system-performance" type="button">
                    <i class="fas fa-tachometer-alt me-2"></i>System Performance
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="maintenanceTabContent">
            <!-- Ports Tab -->
            <div class="tab-pane fade show active" id="ports" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Ports Management</h5>
                        <button class="btn btn-primary" onclick="showPortModal()">
                            <i class="fas fa-plus me-2"></i>Add Port
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="portsSearch" placeholder="Search ports by name, code, city, or country..." onkeyup="handlePortsSearch()">
                                <button class="btn btn-outline-secondary" onclick="clearPortsSearch()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortPorts('id')">
                                            ID <i class="fas fa-sort" id="sort-icon-id"></i>
                                        </th>
                                        <th class="sortable" onclick="sortPorts('portCode')">
                                            Port Code <i class="fas fa-sort" id="sort-icon-portCode"></i>
                                        </th>
                                        <th class="sortable" onclick="sortPorts('name')">
                                            Name <i class="fas fa-sort" id="sort-icon-name"></i>
                                        </th>
                                        <th class="sortable" onclick="sortPorts('city')">
                                            City <i class="fas fa-sort" id="sort-icon-city"></i>
                                        </th>
                                        <th class="sortable" onclick="sortPorts('country')">
                                            Country <i class="fas fa-sort" id="sort-icon-country"></i>
                                        </th>
                                        <th class="sortable" onclick="sortPorts('berthsCapacity')">
                                            Berths Capacity <i class="fas fa-sort" id="sort-icon-berthsCapacity"></i>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="portsTableBody">
                                    <tr><td colspan="7" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ships Tab -->
            <div class="tab-pane fade" id="ships" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Cruise Ships Management</h5>
                        <button class="btn btn-success" onclick="showShipModal()">
                            <i class="fas fa-plus me-2"></i>Add Ship
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="shipsSearch" placeholder="Search ships by name, cruise line, or MMSI..." onkeyup="handleShipsSearch()">
                                <button class="btn btn-outline-secondary" onclick="clearShipsSearch()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortShips('id')">
                                            ID <i class="fas fa-sort" id="sort-icon-ship-id"></i>
                                        </th>
                                        <th class="sortable" onclick="sortShips('name')">
                                            Name <i class="fas fa-sort" id="sort-icon-ship-name"></i>
                                        </th>
                                        <th class="sortable" onclick="sortShips('cruiseLine')">
                                            Cruise Line <i class="fas fa-sort" id="sort-icon-ship-cruiseLine"></i>
                                        </th>
                                        <th class="sortable" onclick="sortShips('capacity')">
                                            Capacity <i class="fas fa-sort" id="sort-icon-ship-capacity"></i>
                                        </th>
                                        <th class="sortable" onclick="sortShips('mmsi')">
                                            MMSI <i class="fas fa-sort" id="sort-icon-ship-mmsi"></i>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shipsTableBody">
                                    <tr><td colspan="6" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Meal Venues Tab -->
            <div class="tab-pane fade" id="meal-venues" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Meal Venues Management</h5>
                        <button class="btn btn-warning" onclick="showMealVenueModal()">
                            <i class="fas fa-plus me-2"></i>Add Meal Venue
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="mealVenuesSearch" placeholder="Search meal venues by name, cuisine, or port..." onkeyup="handleMealVenuesSearch()">
                                <button class="btn btn-outline-secondary" onclick="clearMealVenuesSearch()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortMealVenues('id')">
                                            ID <i class="fas fa-sort" id="sort-icon-venue-id"></i>
                                        </th>
                                        <th class="sortable" onclick="sortMealVenues('name')">
                                            Name <i class="fas fa-sort" id="sort-icon-venue-name"></i>
                                        </th>
                                        <th>Port</th>
                                        <th class="sortable" onclick="sortMealVenues('venueType')">
                                            Venue Type <i class="fas fa-sort" id="sort-icon-venue-venueType"></i>
                                        </th>
                                        <th class="sortable" onclick="sortMealVenues('cuisineType')">
                                            Cuisine <i class="fas fa-sort" id="sort-icon-venue-cuisineType"></i>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mealVenuesTableBody">
                                    <tr><td colspan="6" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Restaurants Tab -->
            <div class="tab-pane fade" id="restaurants" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Restaurants Management</h5>
                        <button class="btn btn-info" onclick="showRestaurantModal()">
                            <i class="fas fa-plus me-2"></i>Add Restaurant
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Search Bar -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="restaurantsSearch" placeholder="Search restaurants by name, cuisine, or port..." onkeyup="handleRestaurantsSearch()">
                                <button class="btn btn-outline-secondary" onclick="clearRestaurantsSearch()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th class="sortable" onclick="sortRestaurants('id')">
                                            ID <i class="fas fa-sort" id="sort-icon-restaurant-id"></i>
                                        </th>
                                        <th class="sortable" onclick="sortRestaurants('name')">
                                            Name <i class="fas fa-sort" id="sort-icon-restaurant-name"></i>
                                        </th>
                                        <th>Port</th>
                                        <th class="sortable" onclick="sortRestaurants('cuisineType')">
                                            Cuisine Type <i class="fas fa-sort" id="sort-icon-restaurant-cuisineType"></i>
                                        </th>
                                        <th class="sortable" onclick="sortRestaurants('rating')">
                                            Rating <i class="fas fa-sort" id="sort-icon-restaurant-rating"></i>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="restaurantsTableBody">
                                    <tr><td colspan="6" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Performance Tab -->
            <div class="tab-pane fade" id="system-performance" role="tabpanel">
                <div class="row mb-4">
                    <!-- API Performance Section -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-tachometer-alt me-2"></i>API Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Total Requests</small>
                                        <h4 id="apiPerfTotalRequests">-</h4>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Success Rate</small>
                                        <h4 id="apiPerfSuccessRate">-</h4>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Avg Response Time</small>
                                        <h5 id="apiPerfAvgTime">-</h5>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">P95 Response Time</small>
                                        <h5 id="apiPerfP95Time">-</h5>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Top Endpoints</small>
                                    <div id="apiPerfEndpoints" class="mt-2">
                                        <small class="text-muted">Loading...</small>
                                    </div>
                                </div>
                                <div>
                                    <small class="text-muted">Error Types</small>
                                    <div id="apiPerfErrors" class="mt-2">
                                        <small class="text-muted">Loading...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resource Utilization Section -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-server me-2"></i>Resource Utilization</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">CPU Usage</small>
                                        <h4 id="resourceCpu">-</h4>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar" id="resourceCpuBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Memory Usage</small>
                                        <h4 id="resourceMemory">-</h4>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-info" id="resourceMemoryBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Heap Usage</small>
                                        <h5 id="resourceHeap">-</h5>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-warning" id="resourceHeapBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Disk Usage</small>
                                        <h5 id="resourceDisk">-</h5>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-danger" id="resourceDiskBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">Threads</small>
                                    <h5 id="resourceThreads">-</h5>
                                </div>
                                <div>
                                    <small class="text-muted">Heap Memory</small>
                                    <h6 id="resourceHeapMemory">-</h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Kibana Dashboard Link -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5><i class="fas fa-chart-bar me-2"></i>Advanced Analytics</h5>
                                <p class="text-muted">View detailed system performance metrics and visualizations in Kibana</p>
                                <a href="http://localhost:5601" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt me-2"></i>Open Kibana Dashboard
                                </a>
                                <small class="d-block mt-2 text-muted">
                                    Make sure Elasticsearch and Kibana are running: <code>docker-compose up -d elasticsearch kibana</code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Port Modal -->
    <div class="modal fade" id="portModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="portModalTitle">Add Port</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="portForm">
                        <input type="hidden" id="portId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Port Code *</label>
                                <input type="text" class="form-control" id="portCode" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="portName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">City *</label>
                                <input type="text" class="form-control" id="portCity" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Country *</label>
                                <input type="text" class="form-control" id="portCountry" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Latitude *</label>
                                <input type="number" step="0.00000001" class="form-control" id="portLatitude" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Longitude *</label>
                                <input type="number" step="0.00000001" class="form-control" id="portLongitude" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Berths Capacity *</label>
                                <input type="number" class="form-control" id="portBerthsCapacity" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Map - Drag the pin to set coordinates</label>
                                <div id="portMap"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePort()">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ship Modal -->
    <div class="modal fade" id="shipModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shipModalTitle">Add Ship</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="shipForm">
                        <input type="hidden" id="shipId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="shipName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cruise Line *</label>
                                <input type="text" class="form-control" id="shipCruiseLine" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Capacity *</label>
                                <input type="number" class="form-control" id="shipCapacity" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">MMSI</label>
                                <input type="text" class="form-control" id="shipMmsi" placeholder="e.g., 123456789">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">IMO</label>
                                <input type="text" class="form-control" id="shipImo" placeholder="e.g., IMO1234567">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Call Sign</label>
                                <input type="text" class="form-control" id="shipCallSign">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Length (meters)</label>
                                <input type="number" step="0.01" class="form-control" id="shipLengthMeters">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Width (meters)</label>
                                <input type="number" step="0.01" class="form-control" id="shipWidthMeters">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Year Built</label>
                                <input type="number" class="form-control" id="shipYearBuilt" min="1800" max="2100">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">AIS Enabled</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="shipAisEnabled" checked>
                                    <label class="form-check-label" for="shipAisEnabled">Enable AIS tracking</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveShip()">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
         integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
         crossorigin=""></script>
    <script>
        function getBasePath() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            const pathname = window.location.pathname;
            
            // If served from IntelliJ's web server (port 63342), use full URL to Spring Boot
            if (port === '63342' || port === '') {
                return 'http://localhost:8080/api/v1';
            }
            
            // If served from Spring Boot (port 8080), check if context path is in URL
            // The context path is /api/v1
            if (pathname.startsWith('/api/v1')) {
                return '/api/v1';
            }
            
            // Default: use context path
            return '/api/v1';
        }
        
        function getAuthHeaders() {
            // Try to get token from localStorage first
            let token = localStorage.getItem('token');
            
            // If not in localStorage, try to get from cookie
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'token') {
                        token = decodeURIComponent(value);
                        // Store in localStorage for future use
                        localStorage.setItem('token', token);
                        break;
                    }
                }
            }
            
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            } else {
                console.warn('No token found in localStorage or cookies');
            }
            return headers;
        }
        
        // Ports Management - State
        let portsState = {
            search: '',
            sortBy: null,
            sortDir: 'ASC',
            page: 0,
            size: 10000  // Load all ports at once to avoid pagination issues
        };
        
        // Leaflet map for port editing
        let portMap = null;
        let portMarker = null;
        let latInputHandler = null;
        let lngInputHandler = null;
        
        function initPortMap(lat = 25.7617, lng = -80.1918) {
            // Destroy existing map if it exists
            if (portMap) {
                // Remove event listeners
                if (latInputHandler) {
                    document.getElementById('portLatitude').removeEventListener('change', latInputHandler);
                }
                if (lngInputHandler) {
                    document.getElementById('portLongitude').removeEventListener('change', lngInputHandler);
                }
                portMap.remove();
                portMap = null;
                portMarker = null;
            }
            
            // Initialize map
            portMap = L.map('portMap').setView([lat, lng], 10);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(portMap);
            
            // Create draggable marker
            portMarker = L.marker([lat, lng], {draggable: true}).addTo(portMap);
            
            // Update latitude/longitude inputs when marker is dragged
            portMarker.on('dragend', function(e) {
                const position = portMarker.getLatLng();
                document.getElementById('portLatitude').value = position.lat.toFixed(8);
                document.getElementById('portLongitude').value = position.lng.toFixed(8);
            });
            
            // Update marker position when inputs change
            latInputHandler = updateMarkerFromInputs;
            lngInputHandler = updateMarkerFromInputs;
            document.getElementById('portLatitude').addEventListener('change', latInputHandler);
            document.getElementById('portLongitude').addEventListener('change', lngInputHandler);
        }
        
        function updateMarkerFromInputs() {
            const lat = parseFloat(document.getElementById('portLatitude').value);
            const lng = parseFloat(document.getElementById('portLongitude').value);
            if (!isNaN(lat) && !isNaN(lng) && portMarker && portMap) {
                portMarker.setLatLng([lat, lng]);
                portMap.setView([lat, lng], portMap.getZoom());
            }
        }
        
        async function loadPorts() {
            try {
                let url = `${getBasePath()}/admin/ports?page=${portsState.page}&size=${portsState.size}`;
                if (portsState.search) {
                    url += `&search=${encodeURIComponent(portsState.search)}`;
                }
                if (portsState.sortBy) {
                    url += `&sortBy=${portsState.sortBy}&sortDir=${portsState.sortDir}`;
                }
                
                const response = await fetch(url, { 
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('portsTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    if (data.content && data.content.length > 0) {
                        data.content.forEach(port => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${port.id}</td>
                                <td>${port.portCode}</td>
                                <td>${port.name}</td>
                                <td>${port.city}</td>
                                <td>${port.country}</td>
                                <td>${port.berthsCapacity}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editPort(${port.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePort(${port.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                        
                        // Display pagination info
                        const totalElements = data.totalElements || data.content.length;
                        const totalPages = data.totalPages || 1;
                        const currentPage = data.number !== undefined ? data.number + 1 : 1;
                        const pageSize = data.size || data.content.length;
                        const startElement = ((currentPage - 1) * pageSize) + 1;
                        const endElement = Math.min(startElement + data.content.length - 1, totalElements);
                        
                        // Update pagination info display
                        // Find the table-responsive container to append pagination after it
                        const tableContainer = tbody.closest('.table-responsive');
                        const cardBody = tableContainer ? tableContainer.parentElement : tbody.parentElement.parentElement;
                        
                        let paginationInfo = document.getElementById('portsPaginationInfo');
                        if (!paginationInfo) {
                            // Create pagination info element if it doesn't exist
                            paginationInfo = document.createElement('div');
                            paginationInfo.id = 'portsPaginationInfo';
                            paginationInfo.className = 'mt-2 text-muted small';
                            cardBody.appendChild(paginationInfo);
                        }
                        paginationInfo.innerHTML = `Showing ${startElement}-${endElement} of ${totalElements} ports`;
                        
                        // Add pagination controls if there are multiple pages
                        let paginationControls = document.getElementById('portsPaginationControls');
                        if (totalPages > 1 && !paginationControls) {
                            paginationControls = document.createElement('nav');
                            paginationControls.id = 'portsPaginationControls';
                            paginationControls.setAttribute('aria-label', 'Ports pagination');
                            paginationControls.innerHTML = `
                                <ul class="pagination justify-content-center mt-3">
                                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                                        <a class="page-link" href="#" onclick="goToPortsPage(${currentPage - 1}); return false;">Previous</a>
                                    </li>
                                    <li class="page-item disabled">
                                        <span class="page-link">Page ${currentPage} of ${totalPages}</span>
                                    </li>
                                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                                        <a class="page-link" href="#" onclick="goToPortsPage(${currentPage + 1}); return false;">Next</a>
                                    </li>
                                </ul>
                            `;
                            cardBody.appendChild(paginationControls);
                        } else if (totalPages > 1 && paginationControls) {
                            // Update existing pagination controls
                            paginationControls.innerHTML = `
                                <ul class="pagination justify-content-center mt-3">
                                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                                        <a class="page-link" href="#" onclick="goToPortsPage(${currentPage - 1}); return false;">Previous</a>
                                    </li>
                                    <li class="page-item disabled">
                                        <span class="page-link">Page ${currentPage} of ${totalPages}</span>
                                    </li>
                                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                                        <a class="page-link" href="#" onclick="goToPortsPage(${currentPage + 1}); return false;">Next</a>
                                    </li>
                                </ul>
                            `;
                        } else if (paginationControls) {
                            // Remove pagination controls if not needed
                            paginationControls.remove();
                        }
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No ports found</td></tr>';
                        // Clear pagination info
                        const paginationInfo = document.getElementById('portsPaginationInfo');
                        if (paginationInfo) paginationInfo.innerHTML = '';
                        const paginationControls = document.getElementById('portsPaginationControls');
                        if (paginationControls) paginationControls.remove();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Error loading ports:', response.status, errorText);
                    const tbody = document.getElementById('portsTableBody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${response.status}</td></tr>`;
                    }
                }
            } catch (error) {
                console.error('Error loading ports:', error);
                const tbody = document.getElementById('portsTableBody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
                }
            }
        }
        
        function goToPortsPage(page) {
            if (page < 0) return;
            portsState.page = page - 1; // API uses 0-based indexing
            loadPorts();
        }
        
        function handlePortsSearch() {
            const searchValue = document.getElementById('portsSearch').value;
            portsState.search = searchValue;
            portsState.page = 0; // Reset to first page when searching
            loadPorts();
        }
        
        function clearPortsSearch() {
            document.getElementById('portsSearch').value = '';
            portsState.search = '';
            portsState.page = 0; // Reset to first page when clearing search
            loadPorts();
        }
        
        function sortPorts(field) {
            // Reset to first page when sorting
            portsState.page = 0;
            // Toggle sort direction if same field
            if (portsState.sortBy === field) {
                portsState.sortDir = portsState.sortDir === 'ASC' ? 'DESC' : 'ASC';
            } else {
                portsState.sortBy = field;
                portsState.sortDir = 'ASC';
            }
            
            // Update sort icons
            document.querySelectorAll('[id^="sort-icon-"]').forEach(icon => {
                if (icon.id.startsWith('sort-icon-') && !icon.id.includes('ship') && !icon.id.includes('venue') && !icon.id.includes('restaurant')) {
                    icon.className = 'fas fa-sort';
                }
            });
            
            const icon = document.getElementById(`sort-icon-${field}`);
            if (icon) {
                icon.className = portsState.sortDir === 'ASC' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                icon.parentElement.classList.add('active');
            }
            
            loadPorts();
        }
        
        function showPortModal(id = null) {
            document.getElementById('portId').value = id || '';
            document.getElementById('portModalTitle').textContent = id ? 'Edit Port' : 'Add Port';
            
            const modalElement = document.getElementById('portModal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Wait for modal to be fully shown before initializing map
            modalElement.addEventListener('shown.bs.modal', function onModalShown() {
                modalElement.removeEventListener('shown.bs.modal', onModalShown);
                
                if (id) {
                    fetch(`${getBasePath()}/admin/ports/${id}`, { 
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    })
                        .then(r => r.json())
                        .then(port => {
                            document.getElementById('portCode').value = port.portCode || '';
                            document.getElementById('portName').value = port.name || '';
                            document.getElementById('portCity').value = port.city || '';
                            document.getElementById('portCountry').value = port.country || '';
                            const lat = port.latitude || 25.7617;
                            const lng = port.longitude || -80.1918;
                            document.getElementById('portLatitude').value = lat;
                            document.getElementById('portLongitude').value = lng;
                            document.getElementById('portBerthsCapacity').value = port.berthsCapacity || '';
                            
                            // Initialize map with port coordinates
                            initPortMap(lat, lng);
                        })
                        .catch(error => {
                            console.error('Error loading port:', error);
                            alert('Error loading port data');
                        });
                } else {
                    document.getElementById('portForm').reset();
                    // Initialize map with default coordinates
                    initPortMap(25.7617, -80.1918);
                }
            }, { once: true });
            
            modal.show();
        }
        
        async function savePort() {
            const id = document.getElementById('portId').value;
            const port = {
                portCode: document.getElementById('portCode').value,
                name: document.getElementById('portName').value,
                city: document.getElementById('portCity').value,
                country: document.getElementById('portCountry').value,
                latitude: parseFloat(document.getElementById('portLatitude').value),
                longitude: parseFloat(document.getElementById('portLongitude').value),
                berthsCapacity: parseInt(document.getElementById('portBerthsCapacity').value)
            };
            
            const url = id ? `${getBasePath()}/admin/ports/${id}` : `${getBasePath()}/admin/ports`;
            const method = id ? 'PUT' : 'POST';
            
            const headers = getAuthHeaders();
            console.log('Saving port:', { url, method, headers, port });
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify(port)
                });
                
                console.log('Save port response:', response.status, response.statusText);
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('portModal')).hide();
                    loadPorts();
                } else {
                    const errorText = await response.text();
                    console.error('Error saving port:', response.status, errorText);
                    alert(`Error saving port: ${response.status} - ${errorText.substring(0, 200)}`);
                }
            } catch (error) {
                console.error('Error saving port:', error);
                alert('Error saving port: ' + error.message);
            }
        }
        
        async function deletePort(id) {
            if (confirm('Are you sure you want to delete this port?')) {
                try {
                    const response = await fetch(`${getBasePath()}/admin/ports/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        loadPorts();
                    } else {
                        console.error('Error deleting port:', response.status);
                        alert(`Error deleting port: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error deleting port:', error);
                    alert('Error deleting port: ' + error.message);
                }
            }
        }
        
        function editPort(id) {
            showPortModal(id);
        }
        
        // Ships Management - State
        let shipsState = {
            search: '',
            sortBy: null,
            sortDir: 'ASC'
        };
        
        async function loadShips() {
            try {
                let url = `${getBasePath()}/admin/ships?size=100`;
                if (shipsState.search) {
                    url += `&search=${encodeURIComponent(shipsState.search)}`;
                }
                if (shipsState.sortBy) {
                    url += `&sortBy=${shipsState.sortBy}&sortDir=${shipsState.sortDir}`;
                }
                
                console.log('Loading ships from:', url);
                const response = await fetch(url, { 
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                
                console.log('Ships response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Ships data received:', data);
                    const tbody = document.getElementById('shipsTableBody');
                    if (!tbody) {
                        console.error('shipsTableBody element not found');
                        return;
                    }
                    tbody.innerHTML = '';
                    if (data.content && data.content.length > 0) {
                        data.content.forEach(ship => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${ship.id}</td>
                                <td>${ship.name || '-'}</td>
                                <td>${ship.cruiseLine || '-'}</td>
                                <td>${ship.capacity || '-'}</td>
                                <td>${ship.mmsi || '-'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editShip(${ship.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteShip(${ship.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No ships found</td></tr>';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Error loading ships:', response.status, errorText);
                    const tbody = document.getElementById('shipsTableBody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${response.status} - ${errorText.substring(0, 100)}</td></tr>`;
                    }
                }
            } catch (error) {
                console.error('Error loading ships:', error);
                const tbody = document.getElementById('shipsTableBody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
                }
            }
        }
        
        function handleShipsSearch() {
            const searchValue = document.getElementById('shipsSearch').value;
            shipsState.search = searchValue;
            loadShips();
        }
        
        function clearShipsSearch() {
            document.getElementById('shipsSearch').value = '';
            shipsState.search = '';
            loadShips();
        }
        
        function sortShips(field) {
            if (shipsState.sortBy === field) {
                shipsState.sortDir = shipsState.sortDir === 'ASC' ? 'DESC' : 'ASC';
            } else {
                shipsState.sortBy = field;
                shipsState.sortDir = 'ASC';
            }
            
            document.querySelectorAll('[id^="sort-icon-ship-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const icon = document.getElementById(`sort-icon-ship-${field}`);
            if (icon) {
                icon.className = shipsState.sortDir === 'ASC' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            loadShips();
        }
        
        function showShipModal(id = null) {
            document.getElementById('shipId').value = id || '';
            document.getElementById('shipModalTitle').textContent = id ? 'Edit Ship' : 'Add Ship';
            if (id) {
                fetch(`${getBasePath()}/admin/ships/${id}`, { 
                    headers: getAuthHeaders(),
                    credentials: 'include'
                })
                    .then(r => r.json())
                    .then(ship => {
                        document.getElementById('shipName').value = ship.name || '';
                        document.getElementById('shipCruiseLine').value = ship.cruiseLine || '';
                        document.getElementById('shipCapacity').value = ship.capacity || '';
                        document.getElementById('shipMmsi').value = ship.mmsi || '';
                        document.getElementById('shipImo').value = ship.imo || '';
                        document.getElementById('shipCallSign').value = ship.callSign || '';
                        document.getElementById('shipLengthMeters').value = ship.lengthMeters || '';
                        document.getElementById('shipWidthMeters').value = ship.widthMeters || '';
                        document.getElementById('shipYearBuilt').value = ship.yearBuilt || '';
                        document.getElementById('shipAisEnabled').checked = ship.aisEnabled !== false; // Default to true
                    })
                    .catch(error => {
                        console.error('Error loading ship:', error);
                        alert('Error loading ship data');
                    });
            } else {
                document.getElementById('shipForm').reset();
                document.getElementById('shipAisEnabled').checked = true; // Default to true for new ships
            }
            new bootstrap.Modal(document.getElementById('shipModal')).show();
        }
        
        function editShip(id) {
            showShipModal(id);
        }
        
        async function saveShip() {
            const id = document.getElementById('shipId').value;
            const ship = {
                name: document.getElementById('shipName').value,
                cruiseLine: document.getElementById('shipCruiseLine').value,
                capacity: parseInt(document.getElementById('shipCapacity').value),
                mmsi: document.getElementById('shipMmsi').value || null,
                imo: document.getElementById('shipImo').value || null,
                callSign: document.getElementById('shipCallSign').value || null,
                lengthMeters: document.getElementById('shipLengthMeters').value ? parseFloat(document.getElementById('shipLengthMeters').value) : null,
                widthMeters: document.getElementById('shipWidthMeters').value ? parseFloat(document.getElementById('shipWidthMeters').value) : null,
                yearBuilt: document.getElementById('shipYearBuilt').value ? parseInt(document.getElementById('shipYearBuilt').value) : null,
                aisEnabled: document.getElementById('shipAisEnabled').checked
            };
            
            const url = id ? `${getBasePath()}/admin/ships/${id}` : `${getBasePath()}/admin/ships`;
            const method = id ? 'PUT' : 'POST';
            
            const headers = getAuthHeaders();
            console.log('Saving ship:', { url, method, headers, ship });
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify(ship)
                });
                
                console.log('Save ship response:', response.status, response.statusText);
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('shipModal')).hide();
                    loadShips();
                } else {
                    const errorText = await response.text();
                    console.error('Error saving ship:', response.status, errorText);
                    alert(`Error saving ship: ${response.status} - ${errorText.substring(0, 200)}`);
                }
            } catch (error) {
                console.error('Error saving ship:', error);
                alert('Error saving ship: ' + error.message);
            }
        }
        
        async function deleteShip(id) {
            if (confirm('Are you sure you want to delete this ship?')) {
                try {
                    const response = await fetch(`${getBasePath()}/admin/ships/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        loadShips();
                    } else {
                        console.error('Error deleting ship:', response.status);
                        alert(`Error deleting ship: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error deleting ship:', error);
                    alert('Error deleting ship: ' + error.message);
                }
            }
        }
        
        // Meal Venues Management - State
        let mealVenuesState = {
            search: '',
            sortBy: null,
            sortDir: 'ASC'
        };
        
        async function loadMealVenues() {
            try {
                let url = `${getBasePath()}/admin/meal-venues?size=100`;
                if (mealVenuesState.search) {
                    url += `&search=${encodeURIComponent(mealVenuesState.search)}`;
                }
                if (mealVenuesState.sortBy) {
                    url += `&sortBy=${mealVenuesState.sortBy}&sortDir=${mealVenuesState.sortDir}`;
                }
                
                const response = await fetch(url, { 
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('mealVenuesTableBody');
                    if (!tbody) return;
                    tbody.innerHTML = '';
                    if (data.content && data.content.length > 0) {
                        data.content.forEach(venue => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${venue.id}</td>
                                <td>${venue.name}</td>
                                <td>${venue.port ? venue.port.name : '-'}</td>
                                <td>${venue.venueType || '-'}</td>
                                <td>${venue.cuisineType || '-'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editMealVenue(${venue.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteMealVenue(${venue.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No meal venues found</td></tr>';
                    }
                } else {
                    console.error('Error loading meal venues:', response.status);
                    const tbody = document.getElementById('mealVenuesTableBody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${response.status}</td></tr>`;
                    }
                }
            } catch (error) {
                console.error('Error loading meal venues:', error);
            }
        }
        
        function handleMealVenuesSearch() {
            const searchValue = document.getElementById('mealVenuesSearch').value;
            mealVenuesState.search = searchValue;
            loadMealVenues();
        }
        
        function clearMealVenuesSearch() {
            document.getElementById('mealVenuesSearch').value = '';
            mealVenuesState.search = '';
            loadMealVenues();
        }
        
        function sortMealVenues(field) {
            if (mealVenuesState.sortBy === field) {
                mealVenuesState.sortDir = mealVenuesState.sortDir === 'ASC' ? 'DESC' : 'ASC';
            } else {
                mealVenuesState.sortBy = field;
                mealVenuesState.sortDir = 'ASC';
            }
            
            document.querySelectorAll('[id^="sort-icon-venue-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const icon = document.getElementById(`sort-icon-venue-${field}`);
            if (icon) {
                icon.className = mealVenuesState.sortDir === 'ASC' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            loadMealVenues();
        }
        
        function showMealVenueModal(id = null) {
            alert('Meal venue modal - implement similar to port modal');
        }
        
        function editMealVenue(id) {
            showMealVenueModal(id);
        }
        
        async function deleteMealVenue(id) {
            if (confirm('Are you sure you want to delete this meal venue?')) {
                try {
                    const response = await fetch(`${getBasePath()}/admin/meal-venues/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        loadMealVenues();
                    } else {
                        console.error('Error deleting meal venue:', response.status);
                        alert(`Error deleting meal venue: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error deleting meal venue:', error);
                    alert('Error deleting meal venue: ' + error.message);
                }
            }
        }
        
        // Restaurants Management - State
        let restaurantsState = {
            search: '',
            sortBy: null,
            sortDir: 'ASC'
        };
        
        async function loadRestaurants() {
            try {
                let url = `${getBasePath()}/admin/restaurants?size=100`;
                if (restaurantsState.search) {
                    url += `&search=${encodeURIComponent(restaurantsState.search)}`;
                }
                if (restaurantsState.sortBy) {
                    url += `&sortBy=${restaurantsState.sortBy}&sortDir=${restaurantsState.sortDir}`;
                }
                
                const response = await fetch(url, { 
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
                if (response.ok) {
                    const data = await response.json();
                    const tbody = document.getElementById('restaurantsTableBody');
                    if (!tbody) return;
                    tbody.innerHTML = '';
                    if (data.content && data.content.length > 0) {
                        data.content.forEach(restaurant => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${restaurant.id}</td>
                                <td>${restaurant.name}</td>
                                <td>${restaurant.port ? restaurant.port.name : '-'}</td>
                                <td>${restaurant.cuisineType || '-'}</td>
                                <td>${restaurant.rating || '-'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editRestaurant(${restaurant.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRestaurant(${restaurant.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No restaurants found</td></tr>';
                    }
                } else {
                    console.error('Error loading restaurants:', response.status);
                    const tbody = document.getElementById('restaurantsTableBody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${response.status}</td></tr>`;
                    }
                }
            } catch (error) {
                console.error('Error loading restaurants:', error);
            }
        }
        
        function handleRestaurantsSearch() {
            const searchValue = document.getElementById('restaurantsSearch').value;
            restaurantsState.search = searchValue;
            loadRestaurants();
        }
        
        function clearRestaurantsSearch() {
            document.getElementById('restaurantsSearch').value = '';
            restaurantsState.search = '';
            loadRestaurants();
        }
        
        function sortRestaurants(field) {
            if (restaurantsState.sortBy === field) {
                restaurantsState.sortDir = restaurantsState.sortDir === 'ASC' ? 'DESC' : 'ASC';
            } else {
                restaurantsState.sortBy = field;
                restaurantsState.sortDir = 'ASC';
            }
            
            document.querySelectorAll('[id^="sort-icon-restaurant-"]').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            
            const icon = document.getElementById(`sort-icon-restaurant-${field}`);
            if (icon) {
                icon.className = restaurantsState.sortDir === 'ASC' ? 'fas fa-sort-up' : 'fas fa-sort-down';
            }
            
            loadRestaurants();
        }
        
        function showRestaurantModal(id = null) {
            alert('Restaurant modal - implement similar to port modal');
        }
        
        function editRestaurant(id) {
            showRestaurantModal(id);
        }
        
        async function deleteRestaurant(id) {
            if (confirm('Are you sure you want to delete this restaurant?')) {
                try {
                    const response = await fetch(`${getBasePath()}/admin/restaurants/${id}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders(),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        loadRestaurants();
                    } else {
                        console.error('Error deleting restaurant:', response.status);
                        alert(`Error deleting restaurant: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error deleting restaurant:', error);
                    alert('Error deleting restaurant: ' + error.message);
                }
            }
        }
        
        // Tab change handlers - ensure Bootstrap is ready
        function setupTabHandlers() {
            const portsTab = document.getElementById('ports-tab');
            const shipsTab = document.getElementById('ships-tab');
            const mealVenuesTab = document.getElementById('meal-venues-tab');
            const restaurantsTab = document.getElementById('restaurants-tab');
            
            if (portsTab) {
                portsTab.addEventListener('shown.bs.tab', loadPorts);
            }
            if (shipsTab) {
                shipsTab.addEventListener('shown.bs.tab', loadShips);
                // Also add click handler as fallback
                shipsTab.addEventListener('click', function() {
                    setTimeout(loadShips, 100); // Small delay to ensure tab is shown
                });
            }
            if (mealVenuesTab) {
                mealVenuesTab.addEventListener('shown.bs.tab', loadMealVenues);
            }
            if (restaurantsTab) {
                restaurantsTab.addEventListener('shown.bs.tab', loadRestaurants);
            }
            
            const systemPerfTab = document.getElementById('system-performance-tab');
            if (systemPerfTab) {
                systemPerfTab.addEventListener('shown.bs.tab', loadSystemPerformance);
            }
        }
        
        // Load statistics summary
        async function loadStatsSummary() {
            try {
                const response = await fetch(`${getBasePath()}/admin/stats/dashboard?hours=24`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    const sparql = stats.sparql || {};
                    const messages = stats.messages || {};
                    const apiPerformance = stats.apiPerformance || {};
                    const resourceUtilization = stats.resourceUtilization || {};
                    
                    // Update SPARQL stats
                    document.getElementById('sparqlTotalQueries').textContent = 
                        formatNumber(sparql.totalQueries || 0);
                    const successRate = sparql.successRate || 0;
                    document.getElementById('sparqlSuccessRate').textContent = 
                        `${successRate.toFixed(1)}% success`;
                    
                    // Update message stats
                    document.getElementById('messageTotal').textContent = 
                        formatNumber(messages.totalMessages || 0);
                    const consumed = messages.consumedMessages || 0;
                    const total = messages.totalMessages || 1;
                    document.getElementById('messageConsumed').textContent = 
                        `${consumed}/${total} consumed`;
                    
                    // Update average duration
                    document.getElementById('avgDuration').textContent = 
                        formatNumber(sparql.avgDurationMs || 0, 0);
                    
                    // Update active producers
                    document.getElementById('activeProducers').textContent = 
                        formatNumber((messages.producers || []).length);
                    
                    // Update API performance summary card
                    if (apiPerformance.enabled) {
                        document.getElementById('apiTotalRequests').textContent = 
                            formatNumber(apiPerformance.totalRequests || 0);
                        document.getElementById('apiSuccessRate').textContent = 
                            `${(apiPerformance.successRate || 0).toFixed(1)}% success`;
                    } else {
                        document.getElementById('apiTotalRequests').textContent = '-';
                        document.getElementById('apiSuccessRate').textContent = 'ES disabled';
                    }
                    
                    // Update resource utilization summary card
                    if (resourceUtilization.enabled && resourceUtilization.latest) {
                        const latest = resourceUtilization.latest;
                        const cpu = latest.cpuUsagePercent || 0;
                        const memory = latest.memoryUsagePercent || 0;
                        document.getElementById('cpuUsage').textContent = `${cpu.toFixed(1)}%`;
                        document.getElementById('memoryUsage').textContent = `${memory.toFixed(1)}% memory`;
                    } else {
                        document.getElementById('cpuUsage').textContent = '-';
                        document.getElementById('memoryUsage').textContent = 'ES disabled';
                    }
                }
            } catch (error) {
                console.error('Error loading stats summary:', error);
            }
        }
        
        // Load system performance details
        async function loadSystemPerformance() {
            try {
                const [apiPerfResponse, resourceResponse] = await Promise.all([
                    fetch(`${getBasePath()}/admin/stats/api-performance?hours=24`, {
                        headers: getAuthHeaders()
                    }),
                    fetch(`${getBasePath()}/admin/stats/resource-utilization?hours=24`, {
                        headers: getAuthHeaders()
                    })
                ]);
                
                // Update API Performance
                if (apiPerfResponse.ok) {
                    const apiPerf = await apiPerfResponse.json();
                    if (apiPerf.enabled && !apiPerf.error) {
                        document.getElementById('apiPerfTotalRequests').textContent = 
                            formatNumber(apiPerf.totalRequests || 0);
                        document.getElementById('apiPerfSuccessRate').textContent = 
                            `${(apiPerf.successRate || 0).toFixed(1)}%`;
                        document.getElementById('apiPerfAvgTime').textContent = 
                            `${formatNumber(apiPerf.avgResponseTimeMs || 0, 0)} ms`;
                        document.getElementById('apiPerfP95Time').textContent = 
                            `${formatNumber(apiPerf.p95ResponseTimeMs || 0, 0)} ms`;
                        
                        // Top endpoints
                        const endpointsDiv = document.getElementById('apiPerfEndpoints');
                        if (apiPerf.endpointPerformance && apiPerf.endpointPerformance.length > 0) {
                            endpointsDiv.innerHTML = apiPerf.endpointPerformance.slice(0, 5).map(ep => 
                                `<div class="d-flex justify-content-between mb-1">
                                    <small>${ep.endpoint}</small>
                                    <small class="text-muted">${formatNumber(ep.avgTime, 0)}ms</small>
                                </div>`
                            ).join('');
                        } else {
                            endpointsDiv.innerHTML = '<small class="text-muted">No data</small>';
                        }
                        
                        // Error types
                        const errorsDiv = document.getElementById('apiPerfErrors');
                        if (apiPerf.errorTypes && apiPerf.errorTypes.length > 0) {
                            errorsDiv.innerHTML = apiPerf.errorTypes.slice(0, 5).map(err => 
                                `<div class="d-flex justify-content-between mb-1">
                                    <small class="text-danger">${err.type || 'Unknown'}</small>
                                    <small class="text-muted">${err.count}</small>
                                </div>`
                            ).join('');
                        } else {
                            errorsDiv.innerHTML = '<small class="text-success">No errors</small>';
                        }
                    } else {
                        document.getElementById('apiPerfTotalRequests').textContent = '-';
                        document.getElementById('apiPerfEndpoints').innerHTML = 
                            '<small class="text-muted">' + (apiPerf.error || 'Elasticsearch not enabled') + '</small>';
                    }
                }
                
                // Update Resource Utilization
                if (resourceResponse.ok) {
                    const resource = await resourceResponse.json();
                    if (resource.enabled && !resource.error && resource.latest) {
                        const latest = resource.latest;
                        const cpu = latest.cpuUsagePercent || 0;
                        const memory = latest.memoryUsagePercent || 0;
                        const heap = latest.heapUsagePercent || 0;
                        const disk = latest.diskUsagePercent || 0;
                        
                        document.getElementById('resourceCpu').textContent = `${cpu.toFixed(1)}%`;
                        document.getElementById('resourceCpuBar').style.width = `${cpu}%`;
                        document.getElementById('resourceCpuBar').className = 
                            `progress-bar ${cpu > 80 ? 'bg-danger' : cpu > 60 ? 'bg-warning' : 'bg-success'}`;
                        
                        document.getElementById('resourceMemory').textContent = `${memory.toFixed(1)}%`;
                        document.getElementById('resourceMemoryBar').style.width = `${memory}%`;
                        document.getElementById('resourceMemoryBar').className = 
                            `progress-bar bg-info ${memory > 80 ? 'bg-danger' : memory > 60 ? 'bg-warning' : 'bg-info'}`;
                        
                        document.getElementById('resourceHeap').textContent = `${heap.toFixed(1)}%`;
                        document.getElementById('resourceHeapBar').style.width = `${heap}%`;
                        document.getElementById('resourceHeapBar').className = 
                            `progress-bar bg-warning ${heap > 80 ? 'bg-danger' : heap > 60 ? 'bg-warning' : 'bg-success'}`;
                        
                        document.getElementById('resourceDisk').textContent = `${disk.toFixed(1)}%`;
                        document.getElementById('resourceDiskBar').style.width = `${disk}%`;
                        document.getElementById('resourceDiskBar').className = 
                            `progress-bar bg-danger ${disk > 80 ? 'bg-danger' : disk > 60 ? 'bg-warning' : 'bg-success'}`;
                        
                        document.getElementById('resourceThreads').textContent = 
                            formatNumber(latest.threadCount || 0);
                        
                        const heapUsedMB = (latest.heapUsedBytes || 0) / (1024 * 1024);
                        const heapMaxMB = (latest.heapMaxBytes || 0) / (1024 * 1024);
                        document.getElementById('resourceHeapMemory').textContent = 
                            `${formatNumber(heapUsedMB, 0)} MB / ${formatNumber(heapMaxMB, 0)} MB`;
                    } else {
                        document.getElementById('resourceCpu').textContent = '-';
                        document.getElementById('resourceMemory').textContent = '-';
                    }
                }
            } catch (error) {
                console.error('Error loading system performance:', error);
            }
        }
        
        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return Number(num).toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }
        
        // Load initial data when page loads
        window.addEventListener('DOMContentLoaded', function() {
            setupTabHandlers();
            // Load ports by default (active tab)
            loadPorts();
            // Also preload ships data
            loadShips();
            // Load statistics summary
            loadStatsSummary();
            // Refresh stats every 30 seconds
            setInterval(loadStatsSummary, 30000);
            // Load system performance if tab is active
            const systemPerfTab = document.getElementById('system-performance-tab');
            if (systemPerfTab && systemPerfTab.classList.contains('active')) {
                loadSystemPerformance();
            }
            // Refresh system performance every 30 seconds if tab is visible
            setInterval(() => {
                const systemPerfPane = document.getElementById('system-performance');
                if (systemPerfPane && systemPerfPane.classList.contains('active')) {
                    loadSystemPerformance();
                }
            }, 30000);
        });
        
        async function logout() {
            // Call logout endpoint to clear server-side cookie
            try {
                await fetch(`${getBasePath()}/auth/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            // Clear client-side storage
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            // Clear cookie manually as fallback
            document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            
            // Redirect to login - use Spring Boot server URL with context path
            const basePath = getBasePath();
            const currentPort = window.location.port;
            if (currentPort === '8080') {
                window.location.href = `${basePath}/login`;
            } else {
                window.location.href = 'http://localhost:8080/api/v1/login';
            }
        }
        
        // Initialize page - wrapped in IIFE to allow return statement
        (function() {
            // Check for token in URL (from login redirect) and set cookie
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                // Set cookie for future requests
                document.cookie = `token=${tokenFromUrl}; path=/api/v1; max-age=${7 * 24 * 60 * 60}; SameSite=Lax`;
                document.cookie = `token=${tokenFromUrl}; path=/; max-age=${7 * 24 * 60 * 60}; SameSite=Lax`;
                // Store in localStorage
                localStorage.setItem('token', tokenFromUrl);
                // Remove token from URL for security
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Check authentication
            const token = localStorage.getItem('token') || tokenFromUrl;
            if (!token) {
                const basePath = getBasePath();
                const currentPort = window.location.port;
                if (currentPort === '8080') {
                    window.location.href = `${basePath}/login`;
                } else {
                    window.location.href = 'http://localhost:8080/api/v1/login';
                }
                return;
            }
            
            // Load initial data
            loadPorts();
            // Also preload ships data
            loadShips();
        })();
    </script>
</body>
</html>

